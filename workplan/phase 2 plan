ğŸ”¹ Overview

Phase 2 covers the entire loan lifecycle â€” from digital loan application and guarantor approval to disbursement, repayment, and schedule management.
All logic reflects the formâ€™s policies :

Interest 12 % p.a. (reducing balance)

Late penalty 10 % of unpaid balance

Processing fee KES 300 + insurance deducted at issue

Repayment begins 30 days after disbursement

Top-up allowed at 75 % repayment

Limit = 3 Ã— savings ( â‰¤ KES 1.5 M )

Phase 2 â€” Subtasks & Copilot Prompts
P2.1 â€“ Loan Application Module (API + UI)

Goal: digitize sections A & B of the form â€“ personal + loan info.

Copilot prompt

â€œIn apps/backend/src/modules/loans, create LoanController with:

POST /loans for new loan application.

DTO fields: member_id, loan_amount, purpose, repayment_months, monthly_income, source_income.

Validate eligibility: savings â‰¥ 6 months and loan â‰¤ 3 Ã— savings (2 Ã— if first loan).

Auto-apply processing fee 300 and deduct insurance if mode = â€˜netâ€™.

Status workflow: draft â†’ submitted â†’ under_review â†’ approved â†’ disbursed â†’ active â†’ closed.

Tests for eligibility and fee calculations.
In apps/frontend, build /loans/apply form replicating the paper form fields and validations with Zod.â€

P2.2 â€“ Guarantor Selection & Digital Approvals (Section D)

Goal: mirror guarantor declaration and signatures .

Copilot prompt

â€œAdd guarantors table with (id, loan_id, guarantor_member_id, amount_guaranteed, status [pending|approved|declined], signature_key, approved_at).
Create POST /loans/:id/guarantors to add guarantors and PATCH /loans/:id/guarantors/:gid/approve to digitally approve (OTP or signature image).
Restrict guarantor eligibility to members â‰¥ 12 months and shares â‰¥ guaranteed amount.
Add e2e tests for approval workflow and exposure limit enforcement.
On frontend, build â€˜Select Guarantorsâ€™ step showing member list + share balances and approval buttons linked to Supabase Auth session.â€

P2.3 â€“ Loan Approval & Disbursement (Section F â€“ Official Use)

Goal: implement committee approval + funds release logic.

Copilot prompt

â€œExtend LoanController with POST /loans/:id/approve and POST /loans/:id/disburse.

Approval records approver_id (chairman/secretary/treasurer).

Compute net disbursed = gross â€“ (loan_form_fee 300 + insurance + arrears + optional savings/shares deductions).

Insert transaction type â€˜disbursementâ€™ with receipt_no.

Send M-Pesa B2C stub event (status=pending).
Add audit entries for each action and unit tests verifying net amount and status transitions.â€

P2.4 â€“ Repayment Schedule & Computation

Goal: build amortization table + repayment API.

Copilot prompt

â€œCreate loan_schedules table (id, loan_id, installment_no, due_date, principal_due, interest_due, penalty_due, principal_paid, interest_paid, status).
Generate schedule on approval: reducing balance, interest 12 % p.a. monthly = 1 %, repayment starts 30 days post-disbursement.
Implement service generateSchedule(loan_id) and unit test with fixtures (verify final balance â‰ˆ 0).
Expose GET /loans/:id/schedule to return breakdown for UI.â€

P2.5 â€“ Repayment Posting & Allocation

Goal: handle repayments from M-Pesa or manual deposit.

Copilot prompt

â€œAdd POST /loans/:id/repayments that allocates amount to interest â†’ principal â†’ penalty order, updates loan_schedules, and marks paid when balance â‰¤ 0.
Link to existing transactions table (type=â€˜repaymentâ€™).
Write integration tests for partial and full payments + overpayment carry-forward.
In frontend /loans/:id, add â€˜Make Repaymentâ€™ modal posting to this endpoint.â€

P2.6 â€“ Interest Accrual & Penalty Jobs

Goal: automate monthly interest + late fees (Section B & policy clauses ).

Copilot prompt

â€œAdd BullMQ processor loan-interest that runs monthly on due instalments: adds interest 1 % of remaining principal.
Add penalty-job that applies 10 % of overdue installment amount after 5 days past due.
Post transactions(type='interest'|'penalty') and log audit entries.
Add unit tests for both processors with sample loans.â€

P2.7 â€“ Loan Dashboard (UI + Summary API)

Goal: give members and officers overview of loan status.

Copilot prompt

â€œCreate GET /loans/summary?member_id returning: active loan balance, amount repaid, next due date, arrears.
Add aggregation SQL view for efficiency.
In frontend /dashboard/loans, render cards â€˜Active Loanâ€™, â€˜Next Paymentâ€™, â€˜Guarantor Exposuresâ€™.
Add RTL tests for correct display of values and status colors.â€

P2.8 â€“ Top-Up Eligibility and Business Rules

Goal: enforce policy 75 % repayment before top-up .

Copilot prompt

â€œAdd service LoanService.checkTopUpEligibility(member_id) that returns true only if current loan principal paid â‰¥ 75 %.
Expose GET /loans/topup/eligibility for UI.
Add tests for edge cases (74 % â†’ false, 75 % â†’ true).â€

P2.9 â€“ Digital Signatures & Agreements

Goal: capture applicant and guarantor acknowledgements (Section E & D signatures).

Copilot prompt

â€œIntegrate Supabase Storage bucket signatures.
Add PATCH /loans/:id/signatures for applicant/guarantors to upload image or drawn signature via canvas.
Store keys and timestamp in loan_signatures table (loan_id, party, file_key, signed_at).
Add PDF generator service LoanAgreementService that merges loan details + signatures into a printable agreement (Puppeteer).
Test that generated PDF includes applicant and guarantor names/signatures.â€

P2.10 â€“ Loan Verification & Audit Logging

Goal: ensure audit consistency for every state change.

Copilot prompt

â€œExtend audit trigger to capture table=loans actions.
Add apps/backend/test/loan_audit.spec.ts verifying that each status transition adds audit_log entry (actor, action, before/after).
Include fields loan_amount, approved_by, disbursed_at in comparison.â€

P2.11 â€“ Reports & Analytics

Goal: quick loan portfolio KPIs.

Copilot prompt

â€œAdd GET /reports/loans aggregating: total disbursed, active balance, arrears %, average term, top 5 borrowers, PAR > 30.
Build admin dashboard page with charts (Recharts) displaying these metrics.
Add e2e test that returns expected shape and auth guard only for managers.â€

P2.12 â€“ RLS & Security Verification

Goal: ensure branch/role isolation still holds.

Copilot prompt

â€œExtend rls.spec.ts:

Clerk(A) canâ€™t see loans of Branch B.

Guarantor can view only loans they guarantee.

Manager has read/write in branch.
Confirm Supabase policies for loans and guarantors reflect these rules.â€

âœ… Phase 2 Definition of Done

Loan form digitized per official fields (Aâ€“E)

Guarantors added and digitally approve

Loans approved â†’ disbursed with net amount calculation

Repayment schedule generated & viewable

Repayments post via API and M-Pesa matching

Interest & penalties auto-run monthly

Member dashboard shows loan progress & arrears

Audit trail records all changes and RLS tests pass