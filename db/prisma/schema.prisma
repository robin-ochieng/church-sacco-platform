// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Validated for Prisma 5.22.0
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users & Authentication
model User {
  id        String   @id
  email     String   @unique
  password  String
  role      UserRole @default(MEMBER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  member Member?
  cashierTransactions Transaction[] @relation("CashierTransactions")

  @@map("User")
}

enum UserRole {
  ADMIN
  MEMBER
  TREASURER
  SECRETARY
  CHAIRMAN
  CLERK
  MANAGER
}

// SACCO Members
model Member {
  id                    String   @id
  userId                String   @unique
  memberNumber          String   @unique
  firstName             String
  lastName              String
  middleName            String?
  gender                Gender   @default(OTHER)
  email                 String   @unique // Member's email address
  guardianName          String?  // For minors
  idPassportNumber      String   @unique
  idNumberEncrypted     Bytes?
  idLast4               String?  @db.VarChar(4)
  physicalAddress       String
  poBox                 String?
  churchGroup           String?  // Church group membership
  telephone             String
  phoneEncrypted        Bytes?
  phoneLast4            String?  @db.VarChar(4)
  telephoneAlt          String?  // Alternative phone
  phoneAltEncrypted     Bytes?
  phoneAltLast4         String?  @db.VarChar(4)
  occupation            String?
  employerName          String?
  employerAddress       String?
  passportPhotoUrl      String?  // Stored in Supabase Storage
  dateOfBirth           DateTime
  
  // Referee/Referrer details
  refereeMemberNo       String?  // Format: ATSC-YYYY-NNNN
  refereeName           String?
  refereePhone          String?
  refereeSignature      String?  // Could be signature image URL
  
  // Next of Kin (primary)
  nextOfKinName         String
  nextOfKinPhone        String
  nextOfKinPhoneEncrypted Bytes?
  nextOfKinPhoneLast4   String?  @db.VarChar(4)
  nextOfKinRelationship String
  
  // Witness details
  witnessName           String?
  witnessSignature      String?  // Signature image URL
  witnessDate           DateTime?
  
  // Registration & Status
  registrationFee       Decimal  @default(2000) @db.Decimal(10, 2)
  joiningDate           DateTime @default(now())
  membershipStatus      String   @default("ACTIVE")
  memberSignature       String?  // Member signature image URL
  
  // Backoffice fields
  branchId              String?
  verifiedBy            String?
  verifiedAt            DateTime?
  
  // Agreement acknowledgments
  agreedToTerms         Boolean  @default(false)
  agreedToRefundPolicy  Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  savings       Saving[]
  shares        Share[]
  loans         Loan[]
  contributions Contribution[]
  beneficiaries Beneficiary[]  // Multiple beneficiaries from Reg.01B
  kyc           MemberKyc?     // KYC documents
  transactions  Transaction[]
  guaranteesGiven Guarantor[]  @relation("GuarantorMember") // Loans this member has guaranteed

  @@index([idLast4])
  @@index([phoneLast4])
  @@index([phoneAltLast4])
  @@index([nextOfKinPhoneLast4])
  @@index([memberNumber])
  @@map("Member")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// Beneficiaries (from Reg.01B form)
model Beneficiary {
  id           String   @id
  memberId     String
  fullName     String
  age          Int?
  relationship String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("Beneficiary")
}

// KYC Documents
model MemberKyc {
  id           String    @id @default(cuid())
  memberId     String    @unique
  idFrontKey   String?   // Supabase Storage key for ID front image
  idBackKey    String?   // Supabase Storage key for ID back image
  photoKey     String?   // Supabase Storage key for member photo/selfie
  verifiedBy   String?   // User ID of admin/clerk who verified
  verifiedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("MemberKyc")
}

// Savings
model Saving {
  id           String      @id
  memberId     String
  type         SavingType  @default(REGULAR)
  amount       Decimal     @db.Decimal(10, 2)
  balance      Decimal     @default(0) @db.Decimal(10, 2)
  interestRate Decimal     @default(0) @db.Decimal(5, 2)
  startDate    DateTime    @default(now())
  maturityDate DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  branchId     String?

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("Saving")
}

enum SavingType {
  REGULAR
  FIXED
  EMERGENCY
}

// Shares
model Share {
  id             String   @id
  memberId       String
  numberOfShares Int      @default(0)
  shareValue     Decimal  @db.Decimal(10, 2)
  totalValue     Decimal  @default(0) @db.Decimal(10, 2)
  purchaseDate   DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  branchId       String?

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("Share")
}

// Loans
model Loan {
  id                    String      @id @default(cuid())
  memberId              String
  loanNumber            String      @unique
  amount                Decimal     @db.Decimal(10, 2)
  interestRate          Decimal     @db.Decimal(5, 2)
  durationMonths        Int
  status                LoanStatus  @default(DRAFT)
  purpose               String
  applicationDate       DateTime    @default(now())
  approvalDate          DateTime?
  disbursementDate      DateTime?
  balance               Decimal     @default(0) @db.Decimal(10, 2)
  monthlyPayment        Decimal?    @db.Decimal(10, 2)
  
  // Application Details
  monthlyIncome         Decimal     @db.Decimal(10, 2)
  sourceOfIncome        String
  processingFee         Decimal?    @db.Decimal(10, 2)
  insuranceFee          Decimal?    @db.Decimal(10, 2)
  disbursementMode      String?     // "NET" or "GROSS"

  // Approval & Disbursement Details
  approvedBy            String?     // User ID of approver (chairman/secretary/treasurer)
  disbursedBy           String?     // User ID of disburser
  disbursementReceiptNo String?     // Receipt number for disbursement
  netDisbursedAmount    Decimal?    @db.Decimal(10, 2)  // Amount actually disbursed after deductions
  arrearsDeducted       Decimal?    @db.Decimal(10, 2)  // Any arrears deducted from disbursement
  savingsDeducted       Decimal?    @db.Decimal(10, 2)  // Optional savings deduction
  sharesDeducted        Decimal?    @db.Decimal(10, 2)  // Optional shares deduction

  // Guarantor Details (Optional at application stage)
  guarantorName         String?
  guarantorPhone        String?
  guarantorNationalId   String?
  collateralDescription String?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  branchId              String?

  member       Member         @relation(fields: [memberId], references: [id], onDelete: Cascade)
  repayments   Repayment[]
  guarantors   Guarantor[]
  schedules    LoanSchedule[]

  @@map("Loan")
}

// Loan Guarantors
model Guarantor {
  id                  String          @id @default(cuid())
  loanId              String
  guarantorMemberId   String          // Member who is guaranteeing
  amountGuaranteed    Decimal         @db.Decimal(10, 2)
  status              GuarantorStatus @default(PENDING)
  signatureKey        String?         // Supabase Storage key for signature image
  approvedAt          DateTime?
  declinedAt          DateTime?
  declineReason       String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  loan              Loan    @relation(fields: [loanId], references: [id], onDelete: Cascade)
  guarantorMember   Member  @relation("GuarantorMember", fields: [guarantorMemberId], references: [id], onDelete: Cascade)

  @@unique([loanId, guarantorMemberId]) // A member can only guarantee a loan once
  @@index([guarantorMemberId])
  @@index([loanId])
  @@map("Guarantor")
}

// Loan Repayment Schedule (Amortization Table)
model LoanSchedule {
  id              String              @id @default(cuid())
  loanId          String
  installmentNo   Int                 // 1, 2, 3, ... up to durationMonths
  dueDate         DateTime
  principalDue    Decimal             @db.Decimal(10, 2)
  interestDue     Decimal             @db.Decimal(10, 2)
  penaltyDue      Decimal             @default(0) @db.Decimal(10, 2)
  principalPaid   Decimal             @default(0) @db.Decimal(10, 2)
  interestPaid    Decimal             @default(0) @db.Decimal(10, 2)
  penaltyPaid     Decimal             @default(0) @db.Decimal(10, 2)
  totalDue        Decimal             @db.Decimal(10, 2)  // principalDue + interestDue + penaltyDue
  totalPaid       Decimal             @default(0) @db.Decimal(10, 2)
  balanceAfter    Decimal             @db.Decimal(10, 2)  // Remaining loan balance after this installment
  status          ScheduleStatus      @default(PENDING)
  paidAt          DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([loanId, installmentNo])
  @@index([loanId])
  @@index([dueDate])
  @@index([status])
  @@map("LoanSchedule")
}

enum ScheduleStatus {
  PENDING     // Not yet due
  DUE         // Due for payment
  PARTIAL     // Partially paid
  PAID        // Fully paid
  OVERDUE     // Past due date, not fully paid
}

enum GuarantorStatus {
  PENDING
  APPROVED
  DECLINED
}

enum LoanStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DISBURSED
  ACTIVE
  CLOSED
  REJECTED
  DEFAULTED
}

// Loan Repayments
model Repayment {
  id              String   @id
  loanId          String
  amount          Decimal  @db.Decimal(10, 2)
  paymentDate     DateTime @default(now())
  principalAmount Decimal  @db.Decimal(10, 2)
  interestAmount  Decimal  @db.Decimal(10, 2)
  balanceAfter    Decimal  @db.Decimal(10, 2)
  paymentMethod   String   @default("CASH")
  receiptNumber   String   @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  branchId        String?

  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@map("Repayment")
}

// Contributions
model Contribution {
  id               String           @id
  memberId         String
  type             ContributionType
  amount           Decimal          @db.Decimal(10, 2)
  contributionDate DateTime         @default(now())
  paymentMethod    String           @default("CASH")
  receiptNumber    String           @unique
  description      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  branchId         String?

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("Contribution")
}

enum ContributionType {
  MONTHLY
  QUARTERLY
  ANNUAL
  SPECIAL
}

enum TransactionType {
  SAVINGS_DEPOSIT
  SHARES_DEPOSIT
  SPECIAL_CONTRIBUTION
  MAINTENANCE_FEE
  MONTHLY_CHARGE
  WITHDRAWAL
  ADJUSTMENT
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
}

enum TransactionStatus {
  PENDING
  POSTED
  REVERSED
}

enum TransactionChannel {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CHEQUE
  SYSTEM
}

model Transaction {
  id            String             @id @default(cuid())
  memberId      String
  cashierId     String?
  branchId      String?
  amount        Decimal            @db.Decimal(12, 2)
  type          TransactionType
  channel       TransactionChannel
  status        TransactionStatus  @default(POSTED)
  reference     String?
  narration     String?
  receiptNumber String?            @unique
  valueDate     DateTime           @default(now())
  balanceAfter  Decimal            @default(0) @db.Decimal(14, 2)
  metadata      Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  member  Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  cashier User?  @relation("CashierTransactions", fields: [cashierId], references: [id])
  mpesaMessages MpesaMessage[]

  @@index([memberId])
  @@index([branchId, valueDate])
  @@map("Transaction")
}

// M-Pesa Messages
model MpesaMessage {
  id             String              @id @default(cuid())
  mpesaRef       String              @unique // M-Pesa transaction reference (e.g., SAF12345XYZ)
  msisdn         String              // Phone number that sent money
  amount         Decimal             @db.Decimal(12, 2)
  narrative      String?             // Payment narrative/notes
  rawJson        Json                // Full M-Pesa callback payload
  matchedTxnId   String?             // Links to Transaction.id when matched
  status         MpesaMessageStatus  @default(SUSPENSE)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  matchedTransaction Transaction? @relation(fields: [matchedTxnId], references: [id])

  @@index([msisdn])
  @@index([status])
  @@index([createdAt])
  @@map("MpesaMessage")
}

enum MpesaMessageStatus {
  MATCHED    // Successfully matched to a member and transaction created
  SUSPENSE   // Could not auto-match (ambiguous or no member found)
  DUPLICATE  // mpesaRef already processed
}
