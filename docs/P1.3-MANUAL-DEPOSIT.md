# P1.3 — Manual Deposit (Cashier/Teller)

**Phase:** Phase 1  
**Feature ID:** P1.3  
**Status:** Backend Complete, Frontend Pending  
**Last Updated:** November 16, 2025

---

## Table of Contents

1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Database Design](#database-design)
4. [API Specification](#api-specification)
5. [Business Logic](#business-logic)
6. [Security & Access Control](#security--access-control)
7. [Testing](#testing)
8. [Frontend Requirements](#frontend-requirements)
9. [Usage Examples](#usage-examples)
10. [Troubleshooting](#troubleshooting)

---

## Overview

The Manual Deposit feature enables authorized staff (cashiers, tellers, treasurers) to record member deposits directly through the system. This is a critical financial operation that ensures accurate tracking of member contributions with automatic receipt generation and audit trails.

### Key Features

- ✅ Multiple deposit types (Savings, Shares, Special Contributions)
- ✅ Multiple payment channels (Cash, Mobile Money, Bank Transfer, Cheque)
- ✅ Automatic receipt number generation
- ✅ Real-time balance calculation
- ✅ Branch-level access control
- ✅ Comprehensive audit trail
- ✅ Immutable transaction records

### User Roles

The following roles can access the cashier deposit functionality:

- **CLERK** - Front-desk staff, limited to their branch
- **TREASURER** - Financial officer, limited to their branch
- **MANAGER** - Branch manager, limited to their branch
- **SECRETARY** - Administrative staff, limited to their branch
- **ADMIN** - System administrator, access to all branches
- **CHAIRMAN** - Board chairman, access to all branches

---

## Architecture

### System Components

```
┌─────────────────┐
│   Frontend      │
│  /teller page   │  ← To be implemented
└────────┬────────┘
         │ HTTP/REST
         ↓
┌─────────────────┐
│  CashierController │
│  /cashier/deposits │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  CashierService │
│  Business Logic │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  PrismaService  │
│  Database Layer │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   PostgreSQL    │
│   + Triggers    │
└─────────────────┘
```

### Data Flow

1. **Request Received** → JWT authentication validates user
2. **Authorization Check** → Role and branch access verified
3. **Member Lookup** → System finds member by ID or member number
4. **Validation** → Amount, type, and channel validated
5. **Balance Calculation** → Previous balance fetched and new balance computed
6. **Transaction Creation** → Record inserted in database
7. **Receipt Generation** → Database trigger auto-generates receipt number
8. **Response** → Transaction details with receipt returned to client

---

## Database Design

### Transaction Table

**Location:** `db/prisma/schema.prisma`

```prisma
model Transaction {
  id            String             @id @default(cuid())
  memberId      String             // FK to Member
  cashierId     String?            // FK to User (who processed it)
  branchId      String?            // FK to Branch
  amount        Decimal            @db.Decimal(12, 2)
  type          TransactionType    // Enum: deposit types
  channel       TransactionChannel // Enum: payment method
  status        TransactionStatus  @default(POSTED)
  reference     String?            // External reference (e.g., M-Pesa code)
  narration     String?            // Description/notes
  receiptNumber String?            @unique
  valueDate     DateTime           @default(now())
  balanceAfter  Decimal            @default(0) @db.Decimal(14, 2)
  metadata      Json?              // Additional data
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  member  Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  cashier User?  @relation("CashierTransactions", fields: [cashierId], references: [id])

  @@index([memberId])
  @@index([branchId, valueDate])
  @@map("Transaction")
}
```

### Enums

#### TransactionType

Defines the purpose of the transaction:

```prisma
enum TransactionType {
  SAVINGS_DEPOSIT        // Regular savings account deposit
  SHARES_DEPOSIT         // Share capital purchase
  SPECIAL_CONTRIBUTION   // Special projects/events
  MAINTENANCE_FEE        // Account maintenance
  WITHDRAWAL             // Cash withdrawal (not used in deposits)
  ADJUSTMENT             // Manual corrections
}
```

#### TransactionChannel

Defines how payment was received:

```prisma
enum TransactionChannel {
  CASH             // Physical cash payment
  BANK_TRANSFER    // Direct bank transfer
  MOBILE_MONEY     // M-Pesa, Airtel Money, etc.
  CHEQUE           // Bank cheque
}
```

#### TransactionStatus

Transaction state:

```prisma
enum TransactionStatus {
  PENDING   // Awaiting approval/processing
  POSTED    // Successfully recorded (default)
  REVERSED  // Transaction reversed/cancelled
}
```

### Database Triggers

#### Receipt Generation Trigger

**Function:** `transaction_generate_receipt_trigger()`  
**Location:** `db/prisma/migrations/005_manual_deposits/migration.sql`

```sql
CREATE OR REPLACE FUNCTION transaction_generate_receipt_trigger()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_branch_id TEXT;
BEGIN
  -- Hydrate branchId from member if missing
  IF NEW."branchId" IS NULL THEN
    SELECT m."branchId" INTO v_branch_id 
    FROM "Member" m 
    WHERE m.id = NEW."memberId" LIMIT 1;
    NEW."branchId" := v_branch_id;
  ELSE
    v_branch_id := NEW."branchId";
  END IF;

  -- Generate receipt number if not provided
  IF NEW."receiptNumber" IS NULL OR NEW."receiptNumber" = '' THEN
    NEW."receiptNumber" := generate_receipt_number(v_branch_id);
  END IF;

  RETURN NEW;
END;
$$;
```

**Trigger:** Executes `BEFORE INSERT` on Transaction table

**Receipt Format:** `RCP-{BRANCH_CODE}-{YYYYMMDD}-{SEQUENCE}`  
**Example:** `RCP-B001-20251116-00042`

#### Receipt Immutability Trigger

**Function:** `prevent_receipt_update_trigger()`  
**Purpose:** Prevents modification of receipt numbers after creation

```sql
CREATE TRIGGER transaction_receipt_immutable
  BEFORE UPDATE OF "receiptNumber" ON "Transaction"
  FOR EACH ROW
  EXECUTE FUNCTION prevent_receipt_update_trigger();
```

---

## API Specification

### Base URL

```
/cashier
```

### Authentication

All endpoints require JWT authentication via Bearer token:

```http
Authorization: Bearer <jwt_token>
```

---

### 1. Create Deposit

**Endpoint:** `POST /cashier/deposits`

Creates a new deposit transaction for a member.

#### Request Body

```typescript
{
  memberId?: string;           // Member UUID (use this OR memberNumber)
  memberNumber?: string;        // Member number (use this OR memberId)
  amount: number;              // Amount in KES, max 2 decimal places
  transactionType: TransactionType;  // Deposit type enum
  channel: TransactionChannel;       // Payment method enum
  reference?: string;          // External reference (max 50 chars)
  narration?: string;          // Description (max 280 chars)
  valueDate?: string;          // ISO date, defaults to now
  branchId?: string;           // Branch UUID, defaults to member's branch
  metadata?: object;           // Additional JSON data
}
```

#### Validation Rules

- **Member Identifier:** Either `memberId` OR `memberNumber` required
- **Amount:** Must be positive, maximum 2 decimal places
- **Transaction Type:** Must be a deposit type (SAVINGS_DEPOSIT, SHARES_DEPOSIT, or SPECIAL_CONTRIBUTION)
- **Channel:** Must be a valid payment channel
- **Reference:** Optional, max 50 characters
- **Narration:** Optional, max 280 characters

#### Example Request

```json
{
  "memberNumber": "MEM-001234",
  "amount": 5000.00,
  "transactionType": "SAVINGS_DEPOSIT",
  "channel": "CASH",
  "narration": "Monthly savings deposit - November 2025"
}
```

#### Success Response

**Status:** `201 Created`

```json
{
  "id": "clx8k3m9n0001abc123def456",
  "member": {
    "id": "member-uuid-123",
    "memberNumber": "MEM-001234",
    "name": "John Doe",
    "branchId": "branch-001"
  },
  "amount": 5000.00,
  "type": "SAVINGS_DEPOSIT",
  "channel": "CASH",
  "status": "POSTED",
  "reference": null,
  "narration": "Monthly savings deposit - November 2025",
  "receiptNumber": "RCP-B001-20251116-00042",
  "valueDate": "2025-11-16T10:30:00.000Z",
  "balanceAfter": 15000.00,
  "branchId": "branch-001",
  "createdAt": "2025-11-16T10:30:00.000Z",
  "cashierId": "cashier-user-id"
}
```

#### Error Responses

**400 Bad Request** - Validation error
```json
{
  "statusCode": 400,
  "message": "Provide either memberId or memberNumber",
  "error": "Bad Request"
}
```

**403 Forbidden** - Branch access denied
```json
{
  "statusCode": 403,
  "message": "You are not authorized to access this branch",
  "error": "Forbidden"
}
```

**404 Not Found** - Member not found
```json
{
  "statusCode": 404,
  "message": "Member not found",
  "error": "Not Found"
}
```

---

### 2. Get Deposit by ID

**Endpoint:** `GET /cashier/deposits/:id`

Retrieves a single deposit transaction.

#### Path Parameters

- `id` (string) - Transaction UUID

#### Example Request

```http
GET /cashier/deposits/clx8k3m9n0001abc123def456
Authorization: Bearer <token>
```

#### Success Response

**Status:** `200 OK`

Returns the same structure as the create deposit response.

#### Error Responses

- `404 Not Found` - Transaction doesn't exist
- `403 Forbidden` - Access to transaction's branch denied

---

### 3. List Deposits

**Endpoint:** `GET /cashier/deposits`

Lists deposits with filtering and pagination.

#### Query Parameters

```typescript
{
  transactionType?: TransactionType;  // Filter by type
  channel?: TransactionChannel;       // Filter by channel
  status?: TransactionStatus;         // Filter by status
  fromDate?: string;                  // ISO date, inclusive
  toDate?: string;                    // ISO date, inclusive
  memberId?: string;                  // Filter by member UUID
  memberNumber?: string;              // Filter by member number
  branchId?: string;                  // Filter by branch (admin only)
  limit?: number;                     // Page size (default: 20)
}
```

#### Example Request

```http
GET /cashier/deposits?transactionType=SAVINGS_DEPOSIT&fromDate=2025-11-01&limit=50
Authorization: Bearer <token>
```

#### Success Response

**Status:** `200 OK`

```json
{
  "data": [
    {
      "id": "clx8k3m9n0001abc123def456",
      "member": {
        "id": "member-uuid-123",
        "memberNumber": "MEM-001234",
        "name": "John Doe",
        "branchId": "branch-001"
      },
      "amount": 5000.00,
      "type": "SAVINGS_DEPOSIT",
      "channel": "CASH",
      "status": "POSTED",
      "receiptNumber": "RCP-B001-20251116-00042",
      "valueDate": "2025-11-16T10:30:00.000Z",
      "balanceAfter": 15000.00,
      "createdAt": "2025-11-16T10:30:00.000Z"
    }
    // ... more transactions
  ],
  "meta": {
    "count": 1,
    "limit": 50
  }
}
```

---

## Business Logic

### Balance Calculation

The system maintains a running balance for each member:

1. **Fetch Previous Balance:** Query the most recent transaction for the member
   ```typescript
   const latest = await tx.transaction.findFirst({
     where: { memberId: member.id },
     orderBy: [{ valueDate: 'desc' }, { createdAt: 'desc' }],
   });
   const previousBalance = latest?.balanceAfter ?? new Prisma.Decimal(0);
   ```

2. **Calculate New Balance:** Add deposit amount to previous balance
   ```typescript
   const balanceAfter = previousBalance.plus(amountDecimal);
   ```

3. **Store Balance:** Save `balanceAfter` with the new transaction

**Benefits:**
- Fast balance retrieval (no need to sum all transactions)
- Audit trail (balance at each point in time)
- Data integrity (stored with transaction)

### Transaction Isolation

All deposit operations use database transactions to ensure atomicity:

```typescript
const transaction = await this.prisma.$transaction(async (tx) => {
  // 1. Fetch previous balance
  // 2. Calculate new balance
  // 3. Create transaction record
  // All succeed or all fail
});
```

### Member Lookup

Flexible member identification:

```typescript
// By ID
if (memberId) {
  return prisma.member.findUnique({ where: { id: memberId } });
}

// By Member Number
if (memberNumber) {
  return prisma.member.findUnique({ where: { memberNumber } });
}
```

---

## Security & Access Control

### Authentication Layer

```typescript
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(UserRole.CLERK, UserRole.TREASURER, UserRole.MANAGER, 
       UserRole.ADMIN, UserRole.SECRETARY)
```

**JWT Token Payload:**
```typescript
interface AuthenticatedUser {
  sub: string;        // User ID
  email: string;      // User email
  role: UserRole;     // User role
  branchId?: string;  // Assigned branch
}
```

### Branch-Level Access Control

**Implementation:** `assertBranchAccess()`

```typescript
private assertBranchAccess(user: AuthenticatedUser, branchId?: string | null) {
  // Admins and Chairmen can access any branch
  if (this.isAdmin(user)) {
    return;
  }

  // Other roles must match their assigned branch
  if (!branchId || !user.branchId || branchId !== user.branchId) {
    throw new ForbiddenException('You are not authorized to access this branch');
  }
}
```

**Rules:**
- ✅ ADMIN/CHAIRMAN: Access all branches
- ✅ CLERK/TREASURER/MANAGER/SECRETARY: Access only their assigned branch
- ❌ Any user: Cannot access unassigned branches

### Audit Trail

Every transaction captures:

- **cashierId** - Who created the transaction
- **createdAt** - When it was created
- **updatedAt** - Last modification time
- **receiptNumber** - Immutable reference
- **metadata** - Additional context (optional)

---

## Testing

### Unit Tests

**Location:** `apps/api/src/cashier/__tests__/cashier.service.spec.ts`

**Coverage:** 18 tests

#### Test Categories

**Create Deposit Tests (10)**
```typescript
✓ should successfully create a deposit with member ID
✓ should successfully create a deposit with member number
✓ should correctly calculate balance after with previous balance
✓ should throw BadRequestException when neither memberId nor memberNumber provided
✓ should throw BadRequestException for non-deposit transaction types
✓ should throw NotFoundException when member not found
✓ should throw ForbiddenException when clerk tries to access different branch
✓ should allow admin to create deposit for any branch
✓ should handle amount with 2 decimal places correctly
✓ should use custom valueDate when provided
```

**Get Deposit Tests (3)**
```typescript
✓ should retrieve a deposit by ID
✓ should throw NotFoundException when transaction not found
✓ should throw ForbiddenException when accessing transaction from different branch
```

**List Deposits Tests (5)**
```typescript
✓ should list deposits with default pagination
✓ should filter deposits by transaction type
✓ should filter deposits by date range
✓ should respect custom limit
✓ should filter by member ID
```

#### Running Unit Tests

```bash
cd apps/api
pnpm test cashier.service.spec
```

**Expected Output:**
```
Test Suites: 1 passed, 1 total
Tests:       18 passed, 18 total
Time:        ~1.3s
```

### E2E Tests

**Location:** `apps/api/test/cashier-deposits.e2e-spec.ts`

**Coverage:** 22 tests

#### Test Categories

**POST /cashier/deposits (13 tests)**
- Cash deposit success
- Mobile money deposit with reference
- Bank transfer deposit
- Validation errors (missing fields, invalid amounts)
- Member not found
- Non-deposit transaction types
- Decimal precision handling
- Custom value dates

**GET /cashier/deposits/:id (2 tests)**
- Retrieve by ID
- 404 handling

**GET /cashier/deposits (6 tests)**
- List with pagination
- Filter by type, channel, date range
- Custom limits
- Member filtering

**Authorization (1 test)**
- Reject without token

#### Running E2E Tests

```bash
cd apps/api
pnpm test:e2e cashier-deposits.e2e-spec
```

**Prerequisites:**
- Database connection configured
- Test environment variables set
- Supabase/PostgreSQL accessible

---

## Frontend Requirements

### Page: `/teller`

#### Layout

```
┌──────────────────────────────────────────────┐
│  Manual Deposit - Teller Interface           │
├──────────────────────────────────────────────┤
│                                              │
│  Member Search                               │
│  ┌─────────────────────────────────────┐    │
│  │ Search by Name, Phone, or Member #  │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  Selected Member:                            │
│  ┌─────────────────────────────────────┐    │
│  │ John Doe - MEM-001234               │    │
│  │ Current Balance: KES 10,000.00      │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  Deposit Details                             │
│  ┌─────────────────────────────────────┐    │
│  │ Amount: [___________] KES           │    │
│  │ Type:   [Savings Deposit ▼]         │    │
│  │ Channel: [Cash ▼]                   │    │
│  │ Reference: [____________]            │    │
│  │ Narration: [___________________]    │    │
│  └─────────────────────────────────────┘    │
│                                              │
│  [Cancel]                    [Submit Deposit]│
│                                              │
└──────────────────────────────────────────────┘
```

#### Success Screen

```
┌──────────────────────────────────────────────┐
│  Deposit Successful ✓                         │
├──────────────────────────────────────────────┤
│                                              │
│  Receipt Number: RCP-B001-20251116-00042     │
│                                              │
│  Member: John Doe (MEM-001234)               │
│  Amount: KES 5,000.00                        │
│  Type: Savings Deposit                       │
│  Channel: Cash                               │
│  New Balance: KES 15,000.00                  │
│  Date: 16-Nov-2025 10:30 AM                  │
│                                              │
│  [Print Receipt]     [New Deposit]           │
│                                              │
└──────────────────────────────────────────────┘
```

#### Components Required

1. **MemberSearch Component**
   - Input field with autocomplete
   - Search by: name, phone number, member number
   - Display selected member details

2. **DepositForm Component**
   - Amount input (number, 2 decimals)
   - Transaction type selector (dropdown)
   - Channel selector (dropdown)
   - Reference input (optional)
   - Narration textarea (optional)
   - Submit button

3. **ReceiptPreview Component**
   - Display receipt details
   - Print functionality
   - Download as PDF option

#### State Management

```typescript
interface TellerState {
  selectedMember: Member | null;
  depositAmount: string;
  transactionType: TransactionType;
  channel: TransactionChannel;
  reference: string;
  narration: string;
  isSubmitting: boolean;
  receipt: Transaction | null;
}
```

#### API Integration

```typescript
// Create deposit
const createDeposit = async (data: CreateDepositDto) => {
  const response = await fetch('/cashier/deposits', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  });
  return response.json();
};
```

### RTL Tests Required

**File:** `apps/web/src/app/teller/__tests__/teller.test.tsx`

```typescript
describe('Teller Page', () => {
  it('should search and select a member', async () => {
    // Test member search functionality
  });

  it('should submit deposit successfully', async () => {
    // Test form submission
  });

  it('should display receipt number after successful deposit', async () => {
    // Test receipt display
  });

  it('should validate amount input', () => {
    // Test amount validation
  });

  it('should allow printing receipt', async () => {
    // Test print functionality
  });
});
```

---

## Usage Examples

### Example 1: Cash Deposit

**Scenario:** Member walks in with KES 10,000 cash for savings

```bash
curl -X POST https://api.example.com/cashier/deposits \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "memberNumber": "MEM-005678",
    "amount": 10000.00,
    "transactionType": "SAVINGS_DEPOSIT",
    "channel": "CASH",
    "narration": "Cash deposit at counter"
  }'
```

### Example 2: M-Pesa Deposit

**Scenario:** Member made M-Pesa payment for shares

```bash
curl -X POST https://api.example.com/cashier/deposits \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "memberId": "member-uuid-123",
    "amount": 5000.00,
    "transactionType": "SHARES_DEPOSIT",
    "channel": "MOBILE_MONEY",
    "reference": "RKJ8X9P2QW",
    "narration": "Share purchase - M-Pesa confirmation RKJ8X9P2QW"
  }'
```

### Example 3: Bank Transfer

**Scenario:** Member transferred money via bank for special contribution

```bash
curl -X POST https://api.example.com/cashier/deposits \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "memberNumber": "MEM-002345",
    "amount": 25000.00,
    "transactionType": "SPECIAL_CONTRIBUTION",
    "channel": "BANK_TRANSFER",
    "reference": "TXN-BANK-456789",
    "narration": "Church building fund contribution"
  }'
```

### Example 4: List Today's Deposits

```bash
curl -X GET "https://api.example.com/cashier/deposits?fromDate=2025-11-16&limit=100" \
  -H "Authorization: Bearer <token>"
```

### Example 5: Filter by Member

```bash
curl -X GET "https://api.example.com/cashier/deposits?memberNumber=MEM-001234" \
  -H "Authorization: Bearer <token>"
```

---

## Troubleshooting

### Common Issues

#### 1. "Provide either memberId or memberNumber"

**Cause:** Neither identifier provided  
**Solution:** Include either `memberId` or `memberNumber` in request

```json
{
  "memberNumber": "MEM-001234",  // Add this
  "amount": 1000.00,
  "transactionType": "SAVINGS_DEPOSIT",
  "channel": "CASH"
}
```

#### 2. "Only deposit transaction types are supported"

**Cause:** Trying to use WITHDRAWAL or ADJUSTMENT type  
**Solution:** Use only deposit types:

```json
{
  "transactionType": "SAVINGS_DEPOSIT",  // ✓ Valid
  // NOT "WITHDRAWAL" or "ADJUSTMENT"
}
```

Valid deposit types:
- `SAVINGS_DEPOSIT`
- `SHARES_DEPOSIT`
- `SPECIAL_CONTRIBUTION`

#### 3. "You are not authorized to access this branch"

**Cause:** User trying to access member from different branch  
**Solution:** 
- Ensure user is assigned to correct branch
- Or use ADMIN/CHAIRMAN role for cross-branch access

#### 4. Receipt number not generated

**Cause:** Database trigger not installed  
**Solution:** Run migration 005

```bash
cd db
pnpm prisma migrate deploy
```

#### 5. "Member not found"

**Cause:** Invalid member ID or number  
**Solution:** 
- Verify member exists in database
- Check spelling of member number
- Ensure member is active

#### 6. Balance not calculating correctly

**Cause:** Transactions out of order or missing valueDate  
**Solution:**
- Always provide `valueDate` for backdated entries
- System orders by `valueDate` then `createdAt`

### Debugging Tips

#### Enable Prisma Query Logging

```typescript
// prisma.service.ts
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
});
```

#### Check Database Triggers

```sql
-- Verify trigger exists
SELECT * FROM pg_trigger 
WHERE tgname = 'transaction_receipt_trigger';

-- Test trigger manually
INSERT INTO "Transaction" (...)
VALUES (...);  -- Should auto-generate receiptNumber
```

#### Validate JWT Token

```bash
# Decode JWT to check claims
echo "<token>" | base64 -d
```

---

## Related Documentation

- [Database Architecture](./03-database-architecture.md)
- [Security & Compliance](./05-security-compliance.md)
- [API Reference](./api-reference.md)
- [Migration 005 README](../db/prisma/migrations/005_manual_deposits/README.md)

---

## Changelog

### v1.0.0 - November 16, 2025

- ✅ Initial implementation
- ✅ Database schema and triggers
- ✅ API endpoints (create, get, list)
- ✅ Branch-level access control
- ✅ Automatic receipt generation
- ✅ Balance calculation
- ✅ Unit tests (18 tests)
- ✅ E2E tests (22 tests)
- ❌ Frontend pending implementation

---

**Document Version:** 1.0  
**Author:** GitHub Copilot  
**Status:** Backend Complete | Frontend Pending
