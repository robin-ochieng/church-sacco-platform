# P2.3 & P2.4 Implementation Summary

## Overview

This document summarizes the implementation of:
- **P2.3**: Loan Approval & Disbursement Enhancement
- **P2.4**: Repayment Schedule & Computation

## Implementation Status: ✅ Complete

---

## 1. Database Schema Updates

### Prisma Schema (`db/prisma/schema.prisma`)

#### New Fields in `Loan` Model
```prisma
// Approval & Disbursement Details
approvedBy            String?     // User ID of approver (chairman/secretary/treasurer)
disbursedBy           String?     // User ID of disburser
disbursementReceiptNo String?     // Receipt number for disbursement
netDisbursedAmount    Decimal?    // Amount actually disbursed after deductions
arrearsDeducted       Decimal?    // Any arrears deducted from disbursement
savingsDeducted       Decimal?    // Optional savings deduction
sharesDeducted        Decimal?    // Optional shares deduction
```

#### New `LoanSchedule` Model
```prisma
model LoanSchedule {
  id              String         @id @default(cuid())
  loanId          String
  installmentNo   Int            // 1, 2, 3, ... up to durationMonths
  dueDate         DateTime
  principalDue    Decimal
  interestDue     Decimal
  penaltyDue      Decimal        @default(0)
  principalPaid   Decimal        @default(0)
  interestPaid    Decimal        @default(0)
  penaltyPaid     Decimal        @default(0)
  totalDue        Decimal
  totalPaid       Decimal        @default(0)
  balanceAfter    Decimal        // Remaining balance after installment
  status          ScheduleStatus @default(PENDING)
  paidAt          DateTime?
}

enum ScheduleStatus {
  PENDING   // Not yet due
  DUE       // Due for payment
  PARTIAL   // Partially paid
  PAID      // Fully paid
  OVERDUE   // Past due date, not fully paid
}
```

---

## 2. Backend API (NestJS)

### New DTOs

| File | Purpose |
|------|---------|
| `approve-loan.dto.ts` | DTO for loan approval with optional comment |
| `disburse-loan.dto.ts` | DTO for disbursement with deduction options |
| `loan-schedule.dto.ts` | Response DTOs for schedule data |

### Services

#### `LoanScheduleService` (`loan-schedule.service.ts`)

| Method | Description |
|--------|-------------|
| `generateSchedule(loanId)` | Generate amortization table using reducing balance method |
| `getScheduleWithDetails(loanId)` | Get schedule with loan details |
| `getScheduleSummary(loanId)` | Get summary for dashboard |
| `updateScheduleStatuses()` | Batch update statuses based on due dates |

**Key Features:**
- Reducing balance amortization (12% p.a. = 1% monthly)
- PMT formula: `P * [r(1+r)^n] / [(1+r)^n - 1]`
- First payment 30 days after disbursement
- Handles existing schedule (idempotent)

#### Enhanced `LoansService` (`loans.service.ts`)

| Method | Description |
|--------|-------------|
| `approveLoan(id, approverId, dto)` | Approve loan with guarantor validation |
| `disburseLoan(id, disburserId, dto)` | Disburse with net amount calculation |
| `findOneWithSchedule(id)` | Get loan with full schedule data |

**Approval Validations:**
- Loan must be SUBMITTED or UNDER_REVIEW
- All guarantors must have approved
- Minimum 2 approved guarantors required
- Total guaranteed amount must cover loan amount

**Disbursement Features:**
- Calculates net amount: `gross - (fees + arrears + deductions)`
- Generates receipt number
- Creates transaction record with metadata
- Supports both NET and GROSS disbursement modes

### Controller Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/loans/:id/approve` | POST | Approve a loan |
| `/loans/:id/disburse` | POST | Disburse an approved loan |
| `/loans/:id/schedule` | GET | Get repayment schedule |
| `/loans/:id/schedule/summary` | GET | Get schedule summary |
| `/loans/:id/schedule/generate` | POST | Generate schedule for approved loan |
| `/loans/:id/full` | GET | Get loan with all related data |

---

## 3. API Usage Examples

### Approve a Loan
```bash
POST /loans/{loanId}/approve
Headers: x-user-id: {approverId}
Body: {
  "comment": "Approved by loan committee"
}
```

### Disburse a Loan
```bash
POST /loans/{loanId}/disburse
Headers: x-user-id: {disburserId}
Body: {
  "arrearsDeducted": 5000,
  "savingsDeducted": 0,
  "sharesDeducted": 0,
  "comment": "Disbursed via M-Pesa"
}
```

Response:
```json
{
  "id": "loan-id",
  "status": "DISBURSED",
  "disbursementDetails": {
    "grossAmount": 100000,
    "processingFee": 300,
    "insuranceFee": 1000,
    "arrearsDeducted": 5000,
    "totalDeductions": 6300,
    "netDisbursedAmount": 93700,
    "receiptNumber": "RCP-20241126-1234"
  }
}
```

### Get Repayment Schedule
```bash
GET /loans/{loanId}/schedule
```

Response:
```json
{
  "loanId": "loan-id",
  "loanNumber": "LN-20241126-0001",
  "loanAmount": 100000,
  "interestRate": 1.0,
  "durationMonths": 12,
  "monthlyPayment": 8884.88,
  "totalInterest": 6618.56,
  "totalPayable": 106618.56,
  "schedule": [
    {
      "installmentNo": 1,
      "dueDate": "2024-12-26",
      "principalDue": 7884.88,
      "interestDue": 1000.00,
      "totalDue": 8884.88,
      "balanceAfter": 92115.12,
      "status": "PENDING"
    },
    // ... more installments
  ]
}
```

---

## 4. Supabase Migration

**File:** `db/supabase-phase2-loan-schedule.sql`

### Tables & Columns
- New `LoanSchedule` table with proper constraints
- New columns on `Loan` table for approval/disbursement tracking

### RLS Policies
1. **Staff**: Full access to all schedules
2. **Members**: View schedules for their own loans
3. **Guarantors**: View schedules for loans they guarantee

### Helper Functions
- `get_loan_schedule_summary(loan_id)`: Returns aggregate summary
- `calculate_monthly_payment(principal, rate, months)`: PMT calculation
- `update_schedule_status()`: Trigger for automatic status updates

### Audit Logging
- Trigger captures loan status changes in audit_log table

---

## 5. Unit Tests

**File:** `apps/api/src/loans/loan-schedule.service.spec.ts`

**21 Tests Covering:**
- Schedule generation for approved loans
- Loan not found handling
- Invalid loan status handling
- Existing schedule detection (idempotent)
- Correct 12-month schedule generation
- PMT formula verification
- Monthly payment calculation
- First payment date (30 days after approval)
- Schedule summary calculations
- Status update batch processing

---

## 6. Files Created/Modified

### New Files
| File | Description |
|------|-------------|
| `apps/api/src/loans/dto/approve-loan.dto.ts` | Approval DTO |
| `apps/api/src/loans/dto/disburse-loan.dto.ts` | Disbursement DTO |
| `apps/api/src/loans/dto/loan-schedule.dto.ts` | Schedule response DTOs |
| `apps/api/src/loans/loan-schedule.service.ts` | Schedule generation service |
| `apps/api/src/loans/loan-schedule.service.spec.ts` | Unit tests |
| `db/supabase-phase2-loan-schedule.sql` | Supabase migration |

### Modified Files
| File | Changes |
|------|---------|
| `db/prisma/schema.prisma` | Added LoanSchedule model, Loan approval fields |
| `apps/api/src/loans/loans.module.ts` | Added LoanScheduleService |
| `apps/api/src/loans/loans.controller.ts` | Added new endpoints |
| `apps/api/src/loans/loans.service.ts` | Added approveLoan, disburseLoan methods |

---

## 7. Next Steps (P2.5+)

1. **P2.5 - Repayment Posting**: Implement payment allocation logic
2. **P2.6 - Interest Accrual & Penalties**: Add scheduled jobs
3. **P2.7 - Loan Dashboard UI**: Build frontend components
4. **P2.8 - Top-Up Eligibility**: Check 75% repayment rule

---

## 8. Running the Migration

```bash
# Generate Prisma client
cd db && npx prisma generate

# Create migration (when database is available)
npx prisma migrate dev --name add_loan_schedule_and_approval_fields

# Apply Supabase migration
psql -h localhost -U postgres -d sacco_db -f db/supabase-phase2-loan-schedule.sql
```

---

## 9. Policy Compliance

| Policy | Implementation |
|--------|----------------|
| Interest 12% p.a. (reducing balance) | ✅ 1% monthly on reducing principal |
| Processing fee KES 300 | ✅ Deducted at disbursement (NET mode) |
| Insurance deducted at issue | ✅ Calculated and deducted |
| Repayment starts 30 days after disbursement | ✅ First due date = disbursement + 30 days |
| Approval by committee | ✅ Records approver_id |
| Guarantor approval required | ✅ Validates all guarantors approved |
