# P1.2 KYC Uploads Implementation Summary

## Overview
Implemented secure KYC document upload functionality using Supabase Storage signed URLs. Members can upload ID front/back, selfie, and photos with proper authorization controls.

## Implementation Date
**Date:** November 2025  
**Status:** ✅ Complete  
**Related:** Phase 1.2 - KYC Document Uploads

---

## Architecture

### Design Pattern
- **Signed URLs**: Pre-signed upload URLs from Supabase Storage (1-hour expiry)
- **Storage Bucket**: `kyc` bucket in Supabase
- **File Structure**: `kyc/{memberId}/{documentType}_{timestamp}.{ext}`
- **Authorization**: JWT-based with role checking (own member, clerk, manager, admin)

### Security Features
1. **JWT Authentication**: All endpoints require valid JWT token
2. **Authorization Guards**: Cross-member access prevented
3. **Role-Based Access**: Clerk/Manager/Admin can upload for any member
4. **Time-Limited URLs**: 1-hour expiry on signed URLs
5. **Folder Isolation**: Each member has their own folder

---

## Files Created

### 1. DTOs (Data Transfer Objects)
**File:** `apps/api/src/kyc/dto/index.ts`

**KycDocumentType Enum:**
- `ID_FRONT` - Front of ID/Passport
- `ID_BACK` - Back of ID/Passport
- `SELFIE` - Selfie photo
- `PHOTO` - General photo

**RequestUploadUrlDto:**
```typescript
{
  documentType: KycDocumentType;  // Required
  fileExtension: string;          // e.g., 'jpg', 'png', 'pdf'
}
```

**UploadUrlResponseDto:**
```typescript
{
  uploadUrl: string;      // Signed URL for upload
  filePath: string;       // Storage path
  expiresIn: number;      // 3600 seconds (1 hour)
}
```

### 2. Service Layer
**File:** `apps/api/src/kyc/kyc.service.ts`

**Methods:**
- `generateUploadUrl()` - Creates signed upload URL
- `getDownloadUrl()` - Creates signed download URL (future use)
- `listMemberDocuments()` - Lists all documents for a member

**Authorization Logic:**
```typescript
// Allow if:
// 1. Own member (member.userId === requestingUserId)
// 2. Clerk/Manager/Admin role
const isOwnMember = member.userId === requestingUserId;
const isAuthorized = isOwnMember || ['clerk', 'manager', 'admin'].includes(userRole);
```

**File Path Generation:**
```
kyc/{memberId}/{documentType}_{timestamp}.{extension}
Example: kyc/123e4567-e89b-12d3-a456-426614174000/id_front_1731628800000.jpg
```

### 3. Controller
**File:** `apps/api/src/kyc/kyc.controller.ts`

**Endpoints:**

#### POST `/api/v1/members/:memberId/kyc/upload-url`
- **Description**: Request signed upload URL
- **Auth**: JWT required
- **Guard**: JwtAuthGuard
- **Request Body**: RequestUploadUrlDto
- **Response**: UploadUrlResponseDto
- **Status Codes**:
  - 200: Success
  - 401: Unauthorized (no/invalid token)
  - 403: Forbidden (cross-member access)
  - 404: Member not found

#### GET `/api/v1/members/:memberId/kyc/documents`
- **Description**: List all KYC documents
- **Auth**: JWT required
- **Response**: Array of file paths
- **Status Codes**:
  - 200: Success
  - 401: Unauthorized
  - 403: Forbidden
  - 404: Member not found

### 4. Module
**File:** `apps/api/src/kyc/kyc.module.ts`
- Imports: AuthModule
- Controllers: KycController
- Providers: KycService, PrismaService, SupabaseService
- Exports: KycService

### 5. Unit Tests
**File:** `apps/api/src/kyc/__tests__/kyc.service.spec.ts`

**Test Suites:**
- `generateUploadUrl()`
  - ✅ Generate URL for own member
  - ✅ Generate URL for clerk accessing member
  - ✅ Generate URL for manager accessing member
  - ✅ Generate URL for admin accessing member
  - ✅ Reject unauthorized cross-member access (403)
  - ✅ Reject non-existent member (404)
  - ✅ Handle Supabase errors
  - ✅ Generate unique file paths per document type

- `getDownloadUrl()`
  - ✅ Generate download URL for own member
  - ✅ Reject unauthorized access

- `listMemberDocuments()`
  - ✅ List all documents
  - ✅ Reject non-existent member

**Test Coverage:** 12+ unit test scenarios

### 6. E2E Tests
**File:** `apps/api/test/kyc-upload.e2e-spec.ts`

**Test Scenarios:**
- **POST /upload-url**
  - ✅ Generate upload URL for own member
  - ✅ Generate URLs for all document types (ID_FRONT, ID_BACK, SELFIE, PHOTO)
  - ✅ Reject without authentication (401)
  - ✅ **Reject cross-member upload (403)** ⭐
  - ✅ Reject non-existent member (404)
  - ✅ Validate missing documentType (400)
  - ✅ Validate invalid documentType (400)
  - ✅ Validate missing fileExtension (400)
  - ✅ Support different file extensions (jpg, jpeg, png, pdf)

- **GET /documents**
  - ✅ List documents for own member
  - ✅ Reject without authentication (401)
  - ✅ Reject listing other member's documents (403)

- **Authorization Scenarios**
  - ✅ **Prevent Member A from uploading for Member B** ⭐
  - ✅ **Prevent Member B from uploading for Member A** ⭐
  - ✅ Generate unique URLs for concurrent requests

**Test Coverage:** 15+ e2e test scenarios

---

## API Usage Examples

### 1. Request Upload URL
```bash
POST /api/v1/members/123e4567-e89b-12d3-a456-426614174000/kyc/upload-url
Authorization: Bearer <jwt-token>
Content-Type: application/json

{
  "documentType": "id_front",
  "fileExtension": "jpg"
}
```

**Response (200):**
```json
{
  "uploadUrl": "https://<supabase-project>.supabase.co/storage/v1/object/sign/kyc/123e4567.../id_front_1731628800000.jpg?token=...",
  "filePath": "kyc/123e4567-e89b-12d3-a456-426614174000/id_front_1731628800000.jpg",
  "expiresIn": 3600
}
```

### 2. Upload File (Client-Side)
```javascript
// Step 1: Get signed URL
const response = await fetch('/api/v1/members/{memberId}/kyc/upload-url', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    documentType: 'id_front',
    fileExtension: 'jpg'
  })
});

const { uploadUrl, filePath } = await response.json();

// Step 2: Upload file to Supabase using signed URL
const file = document.getElementById('fileInput').files[0];
await fetch(uploadUrl, {
  method: 'PUT',
  body: file,
  headers: {
    'Content-Type': 'image/jpeg'
  }
});

// File is now stored at: kyc/{memberId}/id_front_{timestamp}.jpg
```

### 3. List Documents
```bash
GET /api/v1/members/123e4567-e89b-12d3-a456-426614174000/kyc/documents
Authorization: Bearer <jwt-token>
```

**Response (200):**
```json
[
  "123e4567-e89b-12d3-a456-426614174000/id_front_1731628800000.jpg",
  "123e4567-e89b-12d3-a456-426614174000/id_back_1731628801000.jpg",
  "123e4567-e89b-12d3-a456-426614174000/selfie_1731628802000.jpg"
]
```

---

## Authorization Matrix

| User Role | Can Upload for Self | Can Upload for Others | Can View Own Docs | Can View Others' Docs |
|-----------|--------------------|-----------------------|-------------------|----------------------|
| Member    | ✅ Yes             | ❌ No (403)           | ✅ Yes            | ❌ No (403)          |
| Clerk     | ✅ Yes             | ✅ Yes                | ✅ Yes            | ✅ Yes               |
| Manager   | ✅ Yes             | ✅ Yes                | ✅ Yes            | ✅ Yes               |
| Admin     | ✅ Yes             | ✅ Yes                | ✅ Yes            | ✅ Yes               |

---

## Security Implementation

### 1. JWT Authentication
- All endpoints protected by `@UseGuards(JwtAuthGuard)`
- Token must be valid and not expired
- User ID extracted from JWT: `req.user.sub`
- User role extracted from JWT: `req.user.role`

### 2. Authorization Checks
```typescript
// In KycService.generateUploadUrl()
const member = await this.prisma.member.findUnique({ where: { id: memberId } });

if (!member) {
  throw new NotFoundException('Member not found');
}

const isOwnMember = member.userId === requestingUserId;
const isAuthorized = isOwnMember || ['clerk', 'manager', 'admin'].includes(userRole);

if (!isAuthorized) {
  throw new ForbiddenException('Not authorized to upload for this member');
}
```

### 3. Supabase RLS Policies (Recommended)
**Create these policies in Supabase Dashboard:**

```sql
-- Policy: Members can only upload to their own folder
CREATE POLICY "Members can upload to own folder"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'kyc' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Policy: Clerks/Managers/Admins can upload to any folder
CREATE POLICY "Staff can upload to any folder"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'kyc'
  AND auth.jwt() ->> 'role' IN ('clerk', 'manager', 'admin')
);

-- Policy: Members can read own files
CREATE POLICY "Members can read own files"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'kyc'
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- Policy: Staff can read all files
CREATE POLICY "Staff can read all files"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'kyc'
  AND auth.jwt() ->> 'role' IN ('clerk', 'manager', 'admin')
);
```

### 4. Rate Limiting
- Global throttle guard applied (configured in AppModule)
- Default: 10 requests per 60 seconds
- Prevents abuse of signed URL generation

---

## File Organization

```
kyc/                                    (Supabase Storage Bucket)
├── {memberId-1}/                       (Member's folder)
│   ├── id_front_1731628800000.jpg
│   ├── id_back_1731628801000.jpg
│   ├── selfie_1731628802000.jpg
│   └── photo_1731628803000.png
├── {memberId-2}/
│   ├── id_front_1731628900000.pdf
│   └── selfie_1731628901000.jpg
└── ...
```

**Benefits:**
- Clear folder structure per member
- Unique timestamps prevent filename collisions
- Easy to list all documents for a member
- Supports multiple file extensions

---

## Testing

### Run Unit Tests
```bash
cd apps/api
pnpm test kyc.service.spec.ts
```

**Expected Output:**
```
PASS  src/kyc/__tests__/kyc.service.spec.ts
  KycService
    ✓ should be defined
    generateUploadUrl
      ✓ should generate upload URL for own member
      ✓ should generate upload URL for clerk accessing member
      ✓ should generate upload URL for manager accessing member
      ✓ should generate upload URL for admin accessing member
      ✓ should throw ForbiddenException for unauthorized cross-member access
      ✓ should throw NotFoundException for non-existent member
      ✓ should throw error if Supabase fails
      ✓ should generate unique file paths for different document types
    getDownloadUrl
      ✓ should generate download URL for own member
      ✓ should throw ForbiddenException for unauthorized access
    listMemberDocuments
      ✓ should list all documents for a member
      ✓ should throw NotFoundException for non-existent member

Test Suites: 1 passed, 1 total
Tests:       12 passed, 12 total
```

### Run E2E Tests
```bash
cd apps/api
pnpm test:e2e kyc-upload.e2e-spec.ts
```

**Expected Output:**
```
PASS  test/kyc-upload.e2e-spec.ts
  KYC Upload (e2e)
    POST /members/:memberId/kyc/upload-url
      ✓ should generate upload URL for own member
      ✓ should generate upload URL for different document types
      ✓ should reject request without authentication
      ✓ should reject cross-member upload request (403 Forbidden)
      ✓ should reject request for non-existent member (404)
      ✓ should validate request body - missing documentType
      ✓ should validate request body - invalid documentType
      ✓ should validate request body - missing fileExtension
      ✓ should support different file extensions
    GET /members/:memberId/kyc/documents
      ✓ should list documents for own member
      ✓ should reject request without authentication
      ✓ should reject listing documents for other member
    Authorization Scenarios
      ✓ should prevent Member A from uploading for Member B
      ✓ should prevent Member B from uploading for Member A
      ✓ should generate unique upload URLs for concurrent requests

Test Suites: 1 passed, 1 total
Tests:       15 passed, 15 total
```

---

## Environment Variables

**Required in `.env`:**
```bash
# Supabase Configuration
SUPABASE_URL=https://<project-id>.supabase.co
SUPABASE_SERVICE_KEY=<service-role-key>

# JWT Configuration
JWT_SECRET=<your-jwt-secret>
JWT_EXPIRATION=24h
```

**Supabase Storage Bucket:**
- Bucket name: `kyc`
- Public: ❌ No (private bucket)
- File size limit: Recommended 10MB per file
- Allowed MIME types: image/jpeg, image/png, image/jpg, application/pdf

---

## Integration Steps

### 1. Create Supabase Storage Bucket
```bash
# Via Supabase Dashboard:
1. Go to Storage
2. Create new bucket: "kyc"
3. Make it private (uncheck "Public bucket")
4. Set file size limit: 10MB
```

### 2. Apply RLS Policies
```sql
-- Run the SQL policies mentioned in Security Implementation section
-- In Supabase SQL Editor
```

### 3. Update App Module
✅ Already done - KycModule imported in AppModule

### 4. Run Migrations (if needed)
```bash
cd db
npx prisma generate
npx prisma migrate dev
```

---

## Frontend Integration Guide

### 1. Create Upload Component
```typescript
// components/KycUploadForm.tsx
import { useState } from 'react';

export function KycUploadForm({ memberId, token }: Props) {
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);

  const handleUpload = async (documentType: string) => {
    if (!file) return;

    setUploading(true);

    try {
      // Step 1: Get signed URL
      const urlResponse = await fetch(
        `/api/v1/members/${memberId}/kyc/upload-url`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            documentType,
            fileExtension: file.name.split('.').pop(),
          }),
        }
      );

      const { uploadUrl } = await urlResponse.json();

      // Step 2: Upload file
      await fetch(uploadUrl, {
        method: 'PUT',
        body: file,
        headers: {
          'Content-Type': file.type,
        },
      });

      alert('File uploaded successfully!');
    } catch (error) {
      console.error('Upload failed:', error);
      alert('Upload failed. Please try again.');
    } finally {
      setUploading(false);
    }
  };

  return (
    <div>
      <input
        type="file"
        accept="image/*,application/pdf"
        onChange={(e) => setFile(e.target.files?.[0] || null)}
      />
      <button
        onClick={() => handleUpload('id_front')}
        disabled={!file || uploading}
      >
        {uploading ? 'Uploading...' : 'Upload ID Front'}
      </button>
    </div>
  );
}
```

### 2. Add to Registration Flow
```typescript
// In apps/web/src/app/register/success/page.tsx
// After successful registration, redirect to KYC upload page

<Link href={`/members/${memberId}/kyc-upload`}>
  Upload KYC Documents
</Link>
```

---

## Acceptance Criteria

✅ **AC1:** POST `/members/:id/kyc/upload-url` endpoint created  
✅ **AC2:** Returns signed upload URLs from Supabase Storage  
✅ **AC3:** JWT guard implemented - all endpoints require authentication  
✅ **AC4:** Authorization policy: Only same member or clerk/manager can request  
✅ **AC5:** Unit tests for URL issuance (12+ scenarios)  
✅ **AC6:** E2E tests for cross-member access prevention (15+ scenarios)  
✅ **AC7:** Supports all document types: ID_FRONT, ID_BACK, SELFIE, PHOTO  
✅ **AC8:** 1-hour expiry on signed URLs  
✅ **AC9:** Unique file paths with timestamps  
✅ **AC10:** Validation for required fields  

---

## Known Limitations

1. **File Size Validation**: Currently relies on Supabase bucket limits. Could add backend validation.
2. **MIME Type Validation**: No backend validation of file content type.
3. **Document Status**: No database tracking of upload status (planned for Phase 2).
4. **Verification Workflow**: No automated verification of uploaded documents (planned for Phase 2).
5. **Clerk/Manager Auth**: E2E tests simplified - full clerk/manager user creation not implemented.

---

## Next Steps (Phase 2)

1. **Database Tracking**: Add `kyc_documents` table to track uploads
2. **Verification Workflow**: Add status tracking (pending, verified, rejected)
3. **Notifications**: Email notifications when documents uploaded/verified
4. **Admin Dashboard**: View and verify KYC documents
5. **Audit Trail**: Log all access to KYC documents

---

## Related Documentation

- **Phase 1 Kickoff:** `docs/phase-1-kickoff.md`
- **Security Hardening:** `apps/api/docs/SECURITY_HARDENING.md`
- **Supabase Integration:** `SUPABASE_INTEGRATION.md`
- **Member Registration:** `docs/P1.1-IMPLEMENTATION-SUMMARY.md`

---

## Git Commit

**Branch:** `phase-1`

**Commit Message:**
```
feat(api): implement P1.2 KYC document uploads

- Add KycController with signed upload URL endpoint
- Implement KycService with Supabase Storage integration
- Add JWT authentication and role-based authorization
- Prevent cross-member access (only own member or clerk/manager)
- Support 4 document types: ID_FRONT, ID_BACK, SELFIE, PHOTO
- Add 12+ unit tests for URL issuance
- Add 15+ e2e tests for authorization and cross-member access
- Add comprehensive API documentation
- File structure: kyc/{memberId}/{documentType}_{timestamp}.{ext}
- 1-hour expiry on signed URLs

Related: P1.2 KYC Uploads
```

**Files Changed:**
- apps/api/src/kyc/dto/index.ts (NEW)
- apps/api/src/kyc/kyc.service.ts (NEW)
- apps/api/src/kyc/kyc.controller.ts (NEW)
- apps/api/src/kyc/kyc.module.ts (NEW)
- apps/api/src/kyc/__tests__/kyc.service.spec.ts (NEW)
- apps/api/test/kyc-upload.e2e-spec.ts (NEW)
- apps/api/src/app.module.ts (MODIFIED - imported KycModule)

---

## Conclusion

P1.2 KYC Uploads implementation is **complete and ready for testing**. All acceptance criteria met:
- ✅ Signed upload URLs
- ✅ JWT authentication
- ✅ Cross-member access prevention
- ✅ 12+ unit tests
- ✅ 15+ e2e tests
- ✅ Role-based authorization

**Total LOC:** ~1,000+ lines (TypeScript)  
**Test Coverage:** 27+ test scenarios  
**Ready for:** Manual testing, integration with frontend, security audit
