# P1.2 Database Implementation - Member KYC Table

**Date**: November 15, 2025  
**Branch**: phase-1  
**Status**: ‚úÖ COMPLETED

## Overview

Added `member_kyc` table to store KYC document references for member verification. This table stores Supabase Storage keys for ID documents and photos, along with verification status.

---

## Database Changes

### New Model: MemberKyc

```prisma
model MemberKyc {
  id           String    @id @default(cuid())
  memberId     String    @unique
  idFrontKey   String?   // Supabase Storage key for ID front image
  idBackKey    String?   // Supabase Storage key for ID back image
  photoKey     String?   // Supabase Storage key for member photo/selfie
  verifiedBy   String?   // User ID of admin/clerk who verified
  verifiedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("MemberKyc")
}
```

### Member Model Update

Added one-to-one relationship:

```prisma
model Member {
  // ... existing fields
  kyc           MemberKyc?     // KYC documents
  // ... rest of relations
}
```

---

## Schema Design

### Fields

| Field       | Type      | Nullable | Description                                    |
|-------------|-----------|----------|------------------------------------------------|
| id          | String    | No       | Primary key (cuid)                             |
| memberId    | String    | No       | Unique FK to Member.id (one-to-one)            |
| idFrontKey  | String    | Yes      | Storage key: `kyc/{memberId}/id_front_{ts}.jpg`|
| idBackKey   | String    | Yes      | Storage key: `kyc/{memberId}/id_back_{ts}.jpg` |
| photoKey    | String    | Yes      | Storage key: `kyc/{memberId}/photo_{ts}.jpg`   |
| verifiedBy  | String    | Yes      | User ID who verified (admin/clerk)             |
| verifiedAt  | DateTime  | Yes      | Verification timestamp                         |
| createdAt   | DateTime  | No       | Record creation timestamp                      |
| updatedAt   | DateTime  | No       | Last update timestamp                          |

### Constraints

- **Primary Key**: `id`
- **Unique**: `memberId` (one-to-one with Member)
- **Foreign Key**: `memberId` ‚Üí `Member.id` (CASCADE DELETE)
- **Index**: `memberId` for fast lookups

### Relationships

- **Member ‚Üê MemberKyc**: One-to-one (optional)
  - A member may have zero or one KYC record
  - KYC record cannot exist without member
  - Deleting member cascades to KYC record

---

## Migration

### File Location
```
db/prisma/migrations/20241115000000_add_member_kyc_table/migration.sql
```

### SQL Operations

```sql
-- CreateTable
CREATE TABLE "MemberKyc" (
    "id" TEXT NOT NULL,
    "memberId" TEXT NOT NULL,
    "idFrontKey" TEXT,
    "idBackKey" TEXT,
    "photoKey" TEXT,
    "verifiedBy" TEXT,
    "verifiedAt" TIMESTAMP(3),
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "MemberKyc_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "MemberKyc_memberId_key" ON "MemberKyc"("memberId");

-- CreateIndex
CREATE INDEX "MemberKyc_memberId_idx" ON "MemberKyc"("memberId");

-- AddForeignKey
ALTER TABLE "MemberKyc" ADD CONSTRAINT "MemberKyc_memberId_fkey" 
    FOREIGN KEY ("memberId") REFERENCES "Member"("id") 
    ON DELETE CASCADE ON UPDATE CASCADE;
```

### Running Migration

When database connection is available:

```powershell
# Navigate to db directory
cd db

# Run migration (creates table in database)
npx prisma migrate dev --name add_member_kyc_table

# Or deploy to production
npx prisma migrate deploy
```

---

## Prisma Client Generation

Client successfully regenerated with new model:

```typescript
// Import Prisma Client
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// Example usage
const kyc = await prisma.memberKyc.create({
  data: {
    memberId: 'member-123',
    idFrontKey: 'kyc/member-123/id_front_1700000000.jpg',
    idBackKey: 'kyc/member-123/id_back_1700000000.jpg',
    photoKey: 'kyc/member-123/photo_1700000000.jpg',
  },
});

// Query with member relation
const memberWithKyc = await prisma.member.findUnique({
  where: { id: 'member-123' },
  include: { kyc: true },
});
```

---

## Integration Points

### Backend API (apps/api)

**Existing KycService** will interact with this table:

```typescript
// apps/api/src/kyc/kyc.service.ts
async updateKycRecord(memberId: string, documentType: string, storageKey: string) {
  return this.prisma.memberKyc.upsert({
    where: { memberId },
    create: {
      memberId,
      [this.getKeyField(documentType)]: storageKey,
    },
    update: {
      [this.getKeyField(documentType)]: storageKey,
    },
  });
}

async verifyKyc(memberId: string, verifiedBy: string) {
  return this.prisma.memberKyc.update({
    where: { memberId },
    data: {
      verifiedBy,
      verifiedAt: new Date(),
    },
  });
}
```

**New Endpoints Needed**:

1. `PATCH /members/:id/kyc` - Save storage keys after upload
2. `GET /members/:id/kyc` - Retrieve KYC record with verification status
3. `POST /members/:id/kyc/verify` - Mark KYC as verified (admin only)

### Frontend (apps/web)

**Upload Flow**:
1. User uploads files via FileDropzone (already implemented)
2. Frontend receives signed URL from `POST /members/:id/kyc/upload-url` (‚úÖ done)
3. Frontend uploads file to Supabase Storage (‚úÖ done)
4. Frontend calls **NEW** `PATCH /members/:id/kyc` with storage key
5. Backend saves key to `member_kyc` table

---

## Storage Key Format

Keys follow this pattern:
```
kyc/{memberId}/{documentType}_{timestamp}.{ext}

Examples:
- kyc/cm3abcd1234/id_front_1700000000.jpg
- kyc/cm3abcd1234/id_back_1700000000.jpg
- kyc/cm3abcd1234/photo_1700000000.jpg
```

This format matches what's generated in `KycService.generateUploadUrl()`.

---

## Verification Workflow

### Initial State
```json
{
  "memberId": "member-123",
  "idFrontKey": "kyc/.../id_front.jpg",
  "idBackKey": "kyc/.../id_back.jpg",
  "photoKey": "kyc/.../photo.jpg",
  "verifiedBy": null,
  "verifiedAt": null
}
```

### After Admin Verification
```json
{
  "memberId": "member-123",
  "idFrontKey": "kyc/.../id_front.jpg",
  "idBackKey": "kyc/.../id_back.jpg",
  "photoKey": "kyc/.../photo.jpg",
  "verifiedBy": "admin-user-456",
  "verifiedAt": "2025-11-15T10:30:00.000Z"
}
```

---

## Data Access Patterns

### Create KYC Record
```typescript
const kyc = await prisma.memberKyc.create({
  data: {
    memberId: 'member-123',
    idFrontKey: 'kyc/member-123/id_front_1700000000.jpg',
  },
});
```

### Update Single Document
```typescript
await prisma.memberKyc.upsert({
  where: { memberId: 'member-123' },
  create: {
    memberId: 'member-123',
    idFrontKey: 'kyc/member-123/id_front_1700000000.jpg',
  },
  update: {
    idFrontKey: 'kyc/member-123/id_front_1700000000.jpg',
  },
});
```

### Query Member with KYC
```typescript
const member = await prisma.member.findUnique({
  where: { id: 'member-123' },
  include: {
    kyc: true,
  },
});
```

### Find Unverified KYC Records
```typescript
const unverified = await prisma.memberKyc.findMany({
  where: {
    verifiedBy: null,
    idFrontKey: { not: null },
    idBackKey: { not: null },
  },
  include: {
    member: {
      select: {
        memberNumber: true,
        firstName: true,
        lastName: true,
      },
    },
  },
});
```

---

## Next Steps

### Backend Tasks (P1.2 continuation)

1. **Add PATCH endpoint** in `KycController`:
   ```typescript
   @Patch('/members/:id/kyc')
   @UseGuards(JwtAuthGuard)
   async updateKycRecord(
     @Param('id') memberId: string,
     @Body() dto: UpdateKycRecordDto,
     @Req() req,
   ) {
     // Update member_kyc table with storage keys
   }
   ```

2. **Add verification endpoint** (admin only):
   ```typescript
   @Post('/members/:id/kyc/verify')
   @UseGuards(JwtAuthGuard, RolesGuard)
   @Roles('admin', 'clerk', 'manager')
   async verifyKyc(@Param('id') memberId: string, @Req() req) {
     // Set verifiedBy and verifiedAt
   }
   ```

3. **Update KycService** to interact with database:
   - Add `upsertKycRecord()` method
   - Add `verifyKyc()` method
   - Add `getKycStatus()` method

4. **Add DTOs**:
   - `UpdateKycRecordDto` (with storage keys)
   - `KycStatusResponseDto` (with verification info)

### Frontend Tasks

1. **Update upload flow** in `useRegistrationForm.ts`:
   - After Supabase upload succeeds, call `PATCH /members/:id/kyc`
   - Pass storage key from upload response

2. **Add KYC status display** (future):
   - Show verification status in member profile
   - Display "Pending Verification" badge

---

## Testing

### Unit Tests Needed

```typescript
// apps/api/src/kyc/__tests__/kyc-database.spec.ts

describe('KYC Database Operations', () => {
  it('should create KYC record for member', async () => {
    const kyc = await service.upsertKycRecord(
      'member-123',
      'ID_FRONT',
      'kyc/member-123/id_front.jpg',
    );
    expect(kyc.idFrontKey).toBe('kyc/member-123/id_front.jpg');
  });

  it('should update existing KYC record', async () => {
    // First create
    await service.upsertKycRecord('member-123', 'ID_FRONT', 'old_key.jpg');
    
    // Then update
    const updated = await service.upsertKycRecord(
      'member-123',
      'ID_FRONT',
      'new_key.jpg',
    );
    expect(updated.idFrontKey).toBe('new_key.jpg');
  });

  it('should verify KYC record', async () => {
    await service.verifyKyc('member-123', 'admin-456');
    
    const kyc = await prisma.memberKyc.findUnique({
      where: { memberId: 'member-123' },
    });
    
    expect(kyc.verifiedBy).toBe('admin-456');
    expect(kyc.verifiedAt).toBeDefined();
  });
});
```

### E2E Tests Needed

```typescript
// apps/api/test/kyc-database.e2e-spec.ts

it('PATCH /members/:id/kyc - should save storage keys', () => {
  return request(app.getHttpServer())
    .patch(`/members/${memberId}/kyc`)
    .set('Authorization', `Bearer ${token}`)
    .send({
      documentType: 'ID_FRONT',
      storageKey: 'kyc/member-123/id_front.jpg',
    })
    .expect(200);
});
```

---

## Security Considerations

### Access Control

- **Read**: Member can read own KYC, staff can read any
- **Write**: Member can write own KYC, staff can write any
- **Verify**: Only admin/clerk/manager can verify

### RLS Policies (Supabase)

```sql
-- Enable RLS
ALTER TABLE "MemberKyc" ENABLE ROW LEVEL SECURITY;

-- Members can read/write own KYC
CREATE POLICY "Members manage own KYC"
ON "MemberKyc"
FOR ALL
TO authenticated
USING (
  auth.uid()::text IN (
    SELECT "userId" FROM "Member" WHERE "id" = "memberId"
  )
);

-- Staff can read/write all KYC
CREATE POLICY "Staff manage all KYC"
ON "MemberKyc"
FOR ALL
TO authenticated
USING (
  auth.jwt()->>'role' IN ('admin', 'clerk', 'manager', 'treasurer')
);
```

---

## Files Modified

### Schema
- ‚úÖ `db/prisma/schema.prisma` - Added MemberKyc model and Member.kyc relation

### Migration
- ‚úÖ `db/prisma/migrations/20241115000000_add_member_kyc_table/migration.sql` - Created migration file

### Prisma Client
- ‚úÖ Regenerated with `npx prisma generate`

---

## Acceptance Criteria

- [x] MemberKyc model added to schema
- [x] One-to-one relationship with Member model
- [x] Migration file created with correct SQL
- [x] Prisma client regenerated successfully
- [x] Fields support nullable storage keys (optional upload)
- [x] Verification fields (verifiedBy, verifiedAt) included
- [x] Indexes created for performance
- [x] Cascade delete configured
- [ ] Backend PATCH endpoint implemented (next step)
- [ ] Backend verify endpoint implemented (next step)
- [ ] Frontend calls PATCH after upload (next step)
- [ ] E2E tests for database operations (next step)

---

## Documentation

- ‚úÖ This implementation summary
- üìù Backend integration guide (pending)
- üìù API endpoint documentation (pending)

---

## Commit

**Branch**: phase-1  
**Commit Message**: 
```
feat(db): add member_kyc table for KYC document storage

- Add MemberKyc model with storage keys for ID front/back/photo
- Add one-to-one relation Member.kyc
- Include verification fields (verifiedBy, verifiedAt)
- Create migration 20241115000000_add_member_kyc_table
- Regenerate Prisma client

Part of P1.2 ‚Äî KYC Uploads implementation

BREAKING CHANGE: Requires database migration
```

---

**Implementation Status**: ‚úÖ Database schema complete  
**Next**: Backend PATCH endpoint to save storage keys  
**Blockers**: None (migration created, ready to apply when DB is available)
