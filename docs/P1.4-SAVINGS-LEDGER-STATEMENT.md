# P1.4 Savings Ledger & Statement API

## Overview
The Savings Ledger & Statement feature provides members with a comprehensive view of their transaction history, including deposits, withdrawals, and running balance calculations. The API computes running totals server-side for consistency and accuracy.

## API Endpoint

### GET /members/:id/statement

Retrieves a member's savings ledger with all transactions and computed running balance.

**Authentication**: Required (JWT Bearer token)

**Authorization**: Any authenticated user can view member statements

#### URL Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | string | Yes | Member UUID |

#### Query Parameters

| Parameter | Type | Required | Description | Example |
|-----------|------|----------|-------------|---------|
| `s` | string (YYYY-MM-DD) | No | Start date for statement period | `2024-01-01` |
| `e` | string (YYYY-MM-DD) | No | End date for statement period | `2024-12-31` |
| `type` | enum | No | Filter by transaction type | `SAVINGS_DEPOSIT` |

**Transaction Type Enum**:
- `SAVINGS_DEPOSIT`
- `SHARES_DEPOSIT`
- `SPECIAL_CONTRIBUTION`
- `MAINTENANCE_FEE`
- `WITHDRAWAL`
- `ADJUSTMENT`

#### Response

**Status**: 200 OK

```json
{
  "member": {
    "id": "cm123abc456",
    "memberNumber": "MEM001",
    "firstName": "John",
    "lastName": "Doe",
    "email": "john.doe@example.com"
  },
  "period": {
    "startDate": "2024-01-01T00:00:00.000Z",
    "endDate": "2024-12-31T23:59:59.999Z"
  },
  "openingBalance": 0,
  "closingBalance": 25000,
  "totalDeposits": 27000,
  "totalWithdrawals": 2000,
  "transactions": [
    {
      "id": "txn-001",
      "date": "2024-01-05T10:30:00.000Z",
      "type": "SAVINGS_DEPOSIT",
      "channel": "CASH",
      "reference": null,
      "narration": "Opening deposit",
      "debit": 0,
      "credit": 10000,
      "balance": 10000,
      "receiptNumber": "RCP-2024-001234",
      "status": "POSTED",
      "cashierId": "user-123"
    },
    {
      "id": "txn-002",
      "date": "2024-01-15T14:20:00.000Z",
      "type": "SHARES_DEPOSIT",
      "channel": "MOBILE_MONEY",
      "reference": "RKJ8X9P2QW",
      "narration": "Shares purchase",
      "debit": 0,
      "credit": 5000,
      "balance": 15000,
      "receiptNumber": "RCP-2024-001235",
      "status": "POSTED",
      "cashierId": "user-123"
    },
    {
      "id": "txn-003",
      "date": "2024-02-10T09:15:00.000Z",
      "type": "WITHDRAWAL",
      "channel": "CASH",
      "reference": null,
      "narration": "Emergency withdrawal",
      "debit": 2000,
      "credit": 0,
      "balance": 13000,
      "receiptNumber": null,
      "status": "POSTED",
      "cashierId": "user-456"
    }
  ],
  "transactionCount": 3,
  "generatedAt": "2024-11-16T10:30:00.000Z"
}
```

## Features

### 1. Server-Side Running Balance Calculation

The API computes the running balance for each transaction on the server to ensure consistency and accuracy:

```typescript
// Pseudo-code for running balance calculation
let runningBalance = openingBalance;
transactions.forEach(txn => {
  if (isDebit(txn.type)) {
    runningBalance -= txn.amount;
  } else {
    runningBalance += txn.amount;
  }
  txn.balance = runningBalance;
});
```

### 2. Opening Balance Calculation

The opening balance is calculated as the sum of all **POSTED** transactions before the start date:

- If no start date is provided, defaults to `2000-01-01`
- Only includes transactions with `status: 'POSTED'`
- Excludes `PENDING` and `REVERSED` transactions

### 3. Transaction Categorization

**Credits (Deposits)**:
- `SAVINGS_DEPOSIT`
- `SHARES_DEPOSIT`
- `SPECIAL_CONTRIBUTION`
- `MAINTENANCE_FEE`

**Debits (Withdrawals)**:
- `WITHDRAWAL`
- `ADJUSTMENT` (can be positive or negative)

### 4. Date Ordering

Transactions are sorted in **ascending order** by:
1. `valueDate` (primary sort)
2. `createdAt` (secondary sort for same-day transactions)

This ensures chronological accuracy for running balance calculations.

### 5. Period Filtering

- **Default Period**: If no dates provided, returns all transactions from `2000-01-01` to current date
- **Start Date (`s`)**: Filters transactions >= start date at 00:00:00
- **End Date (`e`)**: Filters transactions <= end date at 23:59:59.999

### 6. Transaction Type Filtering

Optional `type` parameter allows filtering by specific transaction types:

```bash
# Example: Get only savings deposits
GET /members/cm123/statement?type=SAVINGS_DEPOSIT

# Example: Get only withdrawals
GET /members/cm123/statement?type=WITHDRAWAL
```

## Request Examples

### 1. Get Full Statement (All Time)

```bash
curl -X GET \
  'http://localhost:3001/members/cm123abc456/statement' \
  -H 'Authorization: Bearer eyJhbGc...'
```

### 2. Get Statement for Date Range

```bash
curl -X GET \
  'http://localhost:3001/members/cm123abc456/statement?s=2024-01-01&e=2024-06-30' \
  -H 'Authorization: Bearer eyJhbGc...'
```

### 3. Get Statement for Specific Transaction Type

```bash
curl -X GET \
  'http://localhost:3001/members/cm123abc456/statement?type=SAVINGS_DEPOSIT' \
  -H 'Authorization: Bearer eyJhbGc...'
```

### 4. Get Statement for Date Range + Type Filter

```bash
curl -X GET \
  'http://localhost:3001/members/cm123abc456/statement?s=2024-01-01&e=2024-12-31&type=WITHDRAWAL' \
  -H 'Authorization: Bearer eyJhbGc...'
```

## Error Responses

### 400 Bad Request - Invalid Date Format

```json
{
  "statusCode": 400,
  "message": ["s must be a valid ISO 8601 date string"],
  "error": "Bad Request"
}
```

### 401 Unauthorized - Missing/Invalid Token

```json
{
  "statusCode": 401,
  "message": "Unauthorized"
}
```

### 404 Not Found - Member Not Found

```json
{
  "statusCode": 404,
  "message": "Member with ID cm123abc456 not found",
  "error": "Not Found"
}
```

## Running Balance Algorithm

### Step-by-Step Calculation

1. **Fetch Opening Balance**:
   ```sql
   SELECT SUM(amount) FROM transactions
   WHERE memberId = :id
     AND status = 'POSTED'
     AND valueDate < :startDate
   ```

2. **Fetch Transactions in Period**:
   ```sql
   SELECT * FROM transactions
   WHERE memberId = :id
     AND status = 'POSTED'
     AND valueDate >= :startDate
     AND valueDate <= :endDate
   ORDER BY valueDate ASC, createdAt ASC
   ```

3. **Compute Running Balance**:
   ```typescript
   let balance = openingBalance;
   
   for (const txn of transactions) {
     const amount = Number(txn.amount);
     
     if (txn.type === 'WITHDRAWAL' || txn.type === 'ADJUSTMENT') {
       balance -= Math.abs(amount);  // Debit
     } else {
       balance += Math.abs(amount);  // Credit
     }
     
     txn.balance = balance;
   }
   ```

4. **Calculate Summary**:
   ```typescript
   totalDeposits = transactions
     .filter(t => t.credit > 0)
     .reduce((sum, t) => sum + t.credit, 0);
   
   totalWithdrawals = transactions
     .filter(t => t.debit > 0)
     .reduce((sum, t) => sum + t.debit, 0);
   
   closingBalance = balance;
   ```

## Testing

### Running E2E Tests

```bash
cd apps/api
pnpm test:e2e member-statement
```

### Test Coverage

The E2E test suite (`member-statement.e2e-spec.ts`) includes **16 comprehensive tests**:

#### Statement Retrieval (3 tests)
- ✅ Returns statement with all required fields
- ✅ Transactions ordered by date ascending
- ✅ Includes all transaction detail fields

#### Running Balance (2 tests)
- ✅ Computes running balance correctly
- ✅ Closing balance matches last transaction

#### Debit/Credit Categorization (1 test)
- ✅ Correctly categorizes debits and credits

#### Date Filtering (4 tests)
- ✅ Filters by date range (s & e params)
- ✅ Validates date format
- ✅ Handles date range with no transactions
- ✅ Calculates opening balance from before start date

#### Transaction Type Filtering (1 test)
- ✅ Filters by transaction type

#### Summary Calculations (1 test)
- ✅ Calculates totalDeposits and totalWithdrawals correctly

#### Edge Cases (4 tests)
- ✅ Returns 404 for non-existent member
- ✅ Only includes POSTED transactions
- ✅ Handles member with no transactions
- ✅ Transaction count matches array length

### Sample Test Data

The test suite seeds the following transactions:

| Date | Type | Amount | Channel | Balance |
|------|------|--------|---------|---------|
| 2024-01-05 | SAVINGS_DEPOSIT | 10,000 | CASH | 10,000 |
| 2024-01-15 | SHARES_DEPOSIT | 5,000 | MOBILE_MONEY | 15,000 |
| 2024-02-01 | SAVINGS_DEPOSIT | 3,000 | BANK_TRANSFER | 18,000 |
| 2024-02-10 | WITHDRAWAL | 2,000 | CASH | 16,000 |
| 2024-03-01 | SPECIAL_CONTRIBUTION | 1,000 | CASH | 17,000 |
| 2024-04-01 | MAINTENANCE_FEE | 500 | CASH | 17,500 |
| 2024-04-15 | SAVINGS_DEPOSIT | 7,500 | CHEQUE | 25,000 |

**Final Balance**: 25,000
**Total Deposits**: 27,000
**Total Withdrawals**: 2,000

## Implementation Details

### Service Method

**Location**: `apps/api/src/members/members.service.ts`

```typescript
async getStatement(
  id: string, 
  query: StatementQueryDto
): Promise<StatementResponseDto> {
  // 1. Verify member exists
  // 2. Build date range filters
  // 3. Get opening balance
  // 4. Fetch transactions in period
  // 5. Compute running balance
  // 6. Calculate summary statistics
  // 7. Return statement
}
```

### Controller Endpoint

**Location**: `apps/api/src/members/members.controller.ts`

```typescript
@Get(':id/statement')
@ApiOperation({ summary: 'Get member savings ledger and statement' })
async getStatement(
  @Param('id') id: string,
  @Query() query: StatementQueryDto,
) {
  return this.membersService.getStatement(id, query);
}
```

### DTOs

**Location**: `apps/api/src/members/dto/statement.dto.ts`

- `StatementQueryDto` - Query parameters
- `LedgerEntryDto` - Individual transaction entry
- `StatementResponseDto` - Complete statement response

## Performance Considerations

### Optimizations

1. **Database Indexing**:
   - Index on `memberId` + `valueDate` for fast filtering
   - Index on `status` for filtering POSTED transactions

2. **Query Optimization**:
   - Single aggregate query for opening balance
   - Single query for transactions in period
   - No N+1 query problems

3. **Server-Side Calculation**:
   - Running balance computed in-memory (O(n))
   - No additional database queries needed

### Expected Performance

- **Small datasets** (<100 transactions): <100ms
- **Medium datasets** (100-1000 transactions): <500ms
- **Large datasets** (>1000 transactions): <2s

## Use Cases

### 1. Monthly Statement Generation

Generate a member's monthly statement:

```bash
GET /members/cm123/statement?s=2024-10-01&e=2024-10-31
```

### 2. Year-to-Date Summary

Get current year activity:

```bash
GET /members/cm123/statement?s=2024-01-01
```

### 3. Savings Deposits Only

View only savings deposits:

```bash
GET /members/cm123/statement?type=SAVINGS_DEPOSIT
```

### 4. Audit Trail

Complete transaction history for auditing:

```bash
GET /members/cm123/statement
```

## Future Enhancements (Out of Scope)

Potential additions for future phases:

1. **PDF Export**: Generate downloadable PDF statements
2. **Email Delivery**: Email statements to members
3. **Pagination**: Support large transaction sets
4. **Batch Export**: Export statements for multiple members
5. **Analytics**: Summary charts and graphs
6. **Scheduled Statements**: Automatic monthly statement generation
7. **Transaction Search**: Full-text search in narrations
8. **Download Formats**: CSV, Excel exports

## Integration with Other Features

### P1.3 Manual Deposit

Deposits created via the Cashier interface automatically appear in member statements:

```typescript
POST /cashier/deposits  // Creates transaction
  ↓
GET /members/:id/statement  // Shows transaction in ledger
```

### Future Withdrawal Feature (P1.5)

Withdrawals will similarly integrate:

```typescript
POST /cashier/withdrawals  // Creates withdrawal
  ↓
GET /members/:id/statement  // Shows as debit in ledger
```

## Security & Authorization

### Access Control

- ✅ JWT authentication required
- ✅ Any authenticated user can view statements
- ✅ Future: Implement member-specific access control (members can only view their own statements)

### Data Privacy

- ✅ Only POSTED transactions included
- ✅ Sensitive fields (cashierId) included for audit
- ✅ Complete transaction history maintained

## Troubleshooting

### Issue: Incorrect Running Balance

**Cause**: Transactions not ordered correctly
**Solution**: Verify `valueDate` and `createdAt` are set correctly

### Issue: Missing Transactions

**Cause**: Transactions in PENDING status
**Solution**: Only POSTED transactions appear in statements

### Issue: Incorrect Opening Balance

**Cause**: Transactions before start date not included
**Solution**: Verify date filtering logic and transaction dates

## Conclusion

The P1.4 Savings Ledger & Statement API provides a robust, server-side solution for generating member transaction statements with accurate running balance calculations. The comprehensive test suite ensures reliability and correctness of all calculations.

**Status**: ✅ **Complete and Production-Ready**

---

*Documentation Version: 1.0*  
*Last Updated: November 16, 2025*  
*Feature: P1.4 - Savings Ledger & Statement*
