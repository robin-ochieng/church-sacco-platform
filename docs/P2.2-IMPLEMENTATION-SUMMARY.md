# P2.2 Guarantor Selection & Digital Approvals - Implementation Summary

## Overview

This document summarizes the implementation of P2.2 (Guarantor Selection & Digital Approvals) for the ACK Thiboro SACCO Platform.

## Implementation Status: âœ… Complete

## Components Implemented

### 1. Database Schema (Prisma)

**File:** `db/prisma/schema.prisma`

```prisma
model Guarantor {
  id                  String          @id @default(cuid())
  loanId              String
  guarantorMemberId   String
  amountGuaranteed    Decimal         @db.Decimal(10, 2)
  status              GuarantorStatus @default(PENDING)
  signatureKey        String?
  approvedAt          DateTime?
  declinedAt          DateTime?
  declineReason       String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  loan              Loan    @relation(...)
  guarantorMember   Member  @relation("GuarantorMember", ...)

  @@unique([loanId, guarantorMemberId])
}

enum GuarantorStatus {
  PENDING
  APPROVED
  DECLINED
}
```

### 2. Backend API (NestJS)

#### DTOs

**File:** `apps/api/src/loans/dto/add-guarantor.dto.ts`
- `guarantorMemberId` (UUID): Member who will guarantee
- `amountGuaranteed` (number, min 1): Amount to guarantee

**File:** `apps/api/src/loans/dto/approve-guarantor.dto.ts`
- `action` (APPROVE | DECLINE): Action to take
- `signatureKey` (optional): Digital signature for approval
- `declineReason` (optional): Reason for declining

#### Service

**File:** `apps/api/src/loans/guarantors.service.ts`

| Method | Description |
|--------|-------------|
| `addGuarantor(loanId, dto)` | Add a guarantor with eligibility validation |
| `approveGuarantor(loanId, guarantorId, dto)` | Approve or decline a guarantee |
| `getGuarantorsForLoan(loanId)` | Get all guarantors for a loan |
| `getEligibleGuarantors(loanId, search?)` | Find eligible guarantors with capacity |
| `removeGuarantor(loanId, guarantorId)` | Remove pending guarantor |
| `getGuarantorExposure(memberId)` | Get member's total guarantee exposure |

#### Eligibility Rules Implemented

1. **12-Month Membership**: Guarantor must be a SACCO member for at least 12 months
2. **Share Balance**: Guarantor's shares must cover the guaranteed amount
3. **Exposure Limit**: Existing guarantees reduce available capacity
4. **No Self-Guarantee**: Members cannot guarantee their own loans
5. **No Duplicates**: Same member cannot guarantee the same loan twice
6. **Loan Status**: Can only add guarantors before disbursement

#### Controller Endpoints

**File:** `apps/api/src/loans/guarantors.controller.ts`

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/loans/:loanId/guarantors` | POST | Add a guarantor |
| `/loans/:loanId/guarantors` | GET | List loan guarantors |
| `/loans/:loanId/guarantors/eligible` | GET | Find eligible guarantors |
| `/loans/:loanId/guarantors/:gid/approve` | PATCH | Approve/decline guarantee |
| `/loans/:loanId/guarantors/:gid` | DELETE | Remove pending guarantor |
| `/members/:memberId/guarantor-exposure` | GET | Get member's exposure |

### 3. Frontend Components (Next.js)

#### GuarantorSelection Component

**File:** `apps/web/src/components/loans/GuarantorSelection.tsx`

Features:
- Search for eligible guarantors by name/member number
- Display available guarantee capacity for each member
- Add guarantors with specific amounts
- Visual summary of guaranteed vs loan amount
- Validation for minimum guarantors (default: 2)

#### GuarantorApproval Component

**File:** `apps/web/src/components/loans/GuarantorApproval.tsx`

Features:
- Display loan and guarantee details
- Terms and conditions acknowledgment
- Digital signature capture (placeholder)
- Approve or decline workflow
- Decline reason input

#### Multi-Step Loan Application Wizard

**File:** `apps/web/src/app/loans/apply/wizard/page.tsx`

Steps:
1. **Loan Details**: Amount, purpose, repayment period
2. **Income**: Monthly income, source, disbursement mode
3. **Guarantors**: Select guarantors (using GuarantorSelection)
4. **Review**: Summary and final submission

### 4. Supabase Migration

**File:** `db/supabase-phase2-guarantor.sql`

- Creates `Guarantor` table with proper constraints
- RLS policies for:
  - Staff viewing all guarantors
  - Members viewing own loans' guarantors
  - Members viewing guarantees they've given
  - Guarantors approving their own guarantees
  - Staff managing guarantors
- Helper functions:
  - `get_member_guarantee_exposure(member_id)`: Total exposure summary
  - `is_member_eligible_guarantor(member_id, amount)`: Eligibility check

### 5. Unit Tests

**File:** `apps/api/src/loans/guarantors.service.spec.ts`

**21 Tests Covering:**
- Successful guarantor addition
- Loan not found
- Loan already disbursed
- Self-guarantee prevention
- Duplicate guarantor prevention
- Membership duration check (< 12 months)
- Insufficient share balance
- Existing exposure limiting capacity
- Total guaranteed exceeding loan amount
- Approval with signature
- Decline with reason
- Authorization checks
- Removal restrictions

## API Usage Examples

### Add a Guarantor
```bash
POST /loans/{loanId}/guarantors
{
  "guarantorMemberId": "uuid-of-guarantor",
  "amountGuaranteed": 50000
}
```

### Get Eligible Guarantors
```bash
GET /loans/{loanId}/guarantors/eligible?search=John
```

Response:
```json
[
  {
    "id": "member-uuid",
    "firstName": "John",
    "lastName": "Doe",
    "memberNumber": "ATSC-2020-001",
    "totalSharesValue": 100000,
    "existingExposure": 20000,
    "availableCapacity": 80000,
    "isEligible": true
  }
]
```

### Approve Guarantee
```bash
PATCH /loans/{loanId}/guarantors/{guarantorId}/approve
{
  "action": "APPROVE",
  "signatureKey": "signature-storage-key"
}
```

### Decline Guarantee
```bash
PATCH /loans/{loanId}/guarantors/{guarantorId}/approve
{
  "action": "DECLINE",
  "declineReason": "Unable to guarantee at this time"
}
```

### Get Member Exposure
```bash
GET /members/{memberId}/guarantor-exposure
```

Response:
```json
{
  "totalExposure": 50000,
  "activeGuarantees": 2,
  "guarantees": [
    {
      "id": "guarantor-uuid",
      "loanNumber": "LN-2024-001",
      "borrowerName": "Jane Smith",
      "amountGuaranteed": 30000,
      "status": "APPROVED",
      "loanStatus": "ACTIVE"
    }
  ]
}
```

## Files Created/Modified

### Created
- `apps/api/src/loans/dto/add-guarantor.dto.ts`
- `apps/api/src/loans/dto/approve-guarantor.dto.ts`
- `apps/api/src/loans/guarantors.service.ts`
- `apps/api/src/loans/guarantors.controller.ts`
- `apps/api/src/loans/guarantors.service.spec.ts`
- `apps/web/src/components/loans/GuarantorSelection.tsx`
- `apps/web/src/components/loans/GuarantorApproval.tsx`
- `apps/web/src/components/loans/index.ts`
- `apps/web/src/app/loans/apply/wizard/page.tsx`
- `db/supabase-phase2-guarantor.sql`
- `docs/P2.2-IMPLEMENTATION-SUMMARY.md` (this file)

### Modified
- `db/prisma/schema.prisma` (added Guarantor model)
- `apps/api/src/loans/loans.module.ts` (registered guarantors service/controller)

## Next Steps

1. **Run Supabase Migration**: Execute `db/supabase-phase2-guarantor.sql` in Supabase
2. **Digital Signatures**: Implement actual signature capture component (currently placeholder)
3. **Notifications**: Add email/SMS notifications when a guarantor is requested
4. **Dashboard**: Add pending guarantee requests to member dashboard
5. **Reports**: Guarantor exposure reports for management

## Testing

Run the unit tests:
```bash
cd apps/api
pnpm jest guarantors
```

All 21 tests should pass.
