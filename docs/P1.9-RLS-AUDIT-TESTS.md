# P1.9 Implementation Summary: RLS & Audit Policy Tests

## ğŸ¯ Objective
Implement comprehensive integration tests to verify Row Level Security (RLS) policies and Audit Logging mechanisms. The goal is to ensure strict data isolation between branches and roles, and to confirm that all critical actions are immutably logged.

## ğŸ›¡ï¸ Security Requirements
1. **Branch Isolation:** Clerk A (Branch A) must not see Members or Transactions from Branch B.
2. **Role Permissions:**
   - **Clerks:** Read/Write access to their branch's data.
   - **Auditors:** Read-only access to ALL branches; NO write access.
   - **Members:** Read-only access to their OWN records only.
3. **Audit Logging:** Critical mutations (INSERT/UPDATE/DELETE) on `Member`, `Transaction`, and `User` tables must create an entry in the `audit_log` table.

## ğŸ› ï¸ Implementation Details

### 1. Test Infrastructure (`apps/api/test/rls.spec.ts`)
The RLS test suite is built using **Jest** and **Supabase Client**. It bypasses the NestJS service layer to test the database policies directly.

**Key Components:**
- **`testData` Fixtures:** Pre-defined IDs for Branches, Users (Clerk A, Clerk B, Auditor), and Transactions to ensure consistent test scenarios.
- **`createAuditorToken` Helper:** Generates a custom JWT with the `AUDITOR` role to test role-specific policies.
- **Direct Supabase Connection:** Uses `createClient` with the generated JWTs to simulate real user requests at the database level.

### 2. Test Scenarios (Implemented & Planned)

#### âœ… Branch Isolation
- **Test:** Clerk A queries `Member` table.
- **Assertion:** Result contains only members with `branchId = 'A'`. Members from Branch B are filtered out by RLS.

#### âœ… Member Privacy
- **Test:** Member A queries `Member` table.
- **Assertion:** Result contains ONLY Member A's record.

#### ğŸš§ Auditor Permissions (In Progress)
- **Plan:** Authenticate as Auditor.
- **Read Test:** Query `Member` table -> Should return ALL members from Branch A and B.
- **Write Test:** Attempt to `INSERT` a new Transaction -> Should fail with `403 Forbidden` or RLS policy violation.

#### ğŸš§ Audit Log Verification (In Progress)
- **Plan:** Perform a `SAVINGS_DEPOSIT` transaction as Clerk A.
- **Assertion:** Query `audit_log` table -> Should find a new record with:
  - `table_name`: 'Transaction'
  - `operation`: 'INSERT'
  - `record_id`: The ID of the new transaction.
  - `performed_by`: Clerk A's User ID.

## ğŸš€ Running the Tests
These tests require a running Supabase instance (local or remote) with the RLS migrations applied.

```bash
# Run RLS integration tests
pnpm --filter api test:e2e -- test/rls.spec.ts
```

## ğŸ“ Next Steps
- Complete the implementation of Auditor write-blocking tests.
- Add assertions for `audit_log` content verification.
- Integrate RLS tests into the CI/CD pipeline.
